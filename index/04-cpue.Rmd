```{r, knitr-opts, echo=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  comment = "#>",
  fig.path = "knitr-figs/",
  cache.path = "knitr-cache/",
  fig.asp = 0.618,
  fig.width = 7.5,
  out.width = "6in",
  echo = FALSE,
  autodep = TRUE,
  cache = TRUE,
  cache.comments = FALSE,
  dev = "png",
  dpi = 200,
  fig.align = "center",
  fig.pos = "htb"
)
```

```{r}
library(dplyr)
library(ggplot2)
```

```{r}
d <- readRDS(here::here("cache/pbs-cpue.rds"))
names(d) <- tolower(names(d))
d <- rename(d, total = totcatch_kg, minor_stat_area_code = min)
d$hours_fished <- as.numeric(as.character(d$hours_fished))
d$database_name <- tolower(d$database_name)
d$gear <- tolower(d$gear)
d$locality_description <- tolower(d$locality_description)

areas <- c("3[CD]+", "5[AB]+", "5[CD]+")
d$area <- NA
for (i in seq_along(areas)) {
  d[grepl(areas[[i]], d$major_stat_area_description), "area"] <-
    gsub("\\[|\\]|\\+", "", areas[[i]])
}
specific_areas <- c("3C", "3D", "5A", "5B", "5C", "5D")
d$specific_area <- NA
for (i in seq_along(specific_areas)) {
  d[grepl(specific_areas[[i]], d$major_stat_area_description), "specific_area"] <-
    specific_areas[[i]]
}

#Get the locality codes
#Paul Starr's locality codes
keyLocality <-
  c(
  "cape scott spit",
  "mexicana",
  "topknot",
  "ne goose",
  "se goose",
  "nw goose",
  "sw goose",
  "reef island",
  "west horseshoe",
  "east horseshoe",
  "two peaks",
  "butterworth",
  "white rocks",
  "shell ground"
  )
x <- d %>%
  select(specific_area, locality_code, locality_description) %>%
  distinct()

# x <- x[with(x, order(x$specific_area,x$locality_code)),]
# Starr_key_locality <- is.element(x$locality_description,keyLocality)
# x <- cbind(x,Starr_key_locality)
# write_csv(x,paste0(outDir,"Locality_Codes.csv"))

dsum <- d %>%
  mutate(
    key_locality =
      specific_area == "5A" & 
      locality_description %in% 
      c("cape scott spit", "mexicana", "topknot") |
        specific_area == "5B" & 
      locality_description %in% 
      c("ne goose", "se goose", "nw goose", "sw goose") |
        specific_area == "5C" & 
      locality_description %in% 
      c("reef island", "west horseshoe", "east horseshoe") |
        specific_area == "5D" & 
      locality_description %in% 
      c("two peaks", "butterworth", "white rocks", "shell ground")
  ) %>%
  filter(!is.na(hours_fished), !is.na(total), hours_fished > 0)
```
