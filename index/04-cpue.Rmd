```{r, knitr-opts, echo=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  comment = "#>",
  fig.path = "knitr-figs/",
  cache.path = "knitr-cache/",
  fig.asp = 0.618,
  fig.width = 7.5,
  out.width = "6in",
  echo = FALSE,
  autodep = TRUE,
  cache = TRUE,
  cache.comments = FALSE,
  dev = "png",
  dpi = 200,
  fig.align = "center",
  fig.pos = "htb"
)
```

```{r}
library(dplyr)
library(ggplot2)
```

```{r read-cpue-historic}
d <- read.csv("~/Dropbox/PBS synopsis/pcod/cpue.csv",
  stringsAsFactors = FALSE, strip.white = TRUE)
# d <- gfplot::get_cpue_historic(species = NULL, end_year = 2017)
```

```{r cpue-historic-basic-filtering}
key_locality <-
  c(
  "cape scott spit",
  "mexicana",
  "topknot",
  "ne goose",
  "se goose",
  "nw goose",
  "sw goose",
  "reef island",
  "west horseshoe",
  "east horseshoe",
  "two peaks",
  "butterworth",
  "white rocks",
  "shell ground"
  )

# Suggested by Paul Starr by email in 2018:
new_locality_2018 <-
  c("triangle", "ole spot", "north moresby", "south bonilla", "west two peaks")

# Make sure we have spelled all the localities correctly:
stopifnot(all(key_locality %in% unique(d$locality_description)))
stopifnot(all(new_locality_2018 %in% unique(d$locality_description)))

# Basic filters that will apply to all data sets:
d <- d %>% filter(!is.na(hours_fished), !is.na(total), !is.na(best_depth_m),
    best_depth_m > 0, hours_fished > 0, total > 0, year >= 1956)
```

```{r cpue-historic-depth}
filter(d, species_code == "222") %>%
  ggplot(aes(best_depth_m)) + geom_histogram(binwidth = 25) +
  geom_vline(xintercept = 150) +
  geom_vline(xintercept = 350) +
  gfplot::theme_pbs()
```

```{r cpue-historic-calculations}
# This is to create 3CD, 5AB, 5CD, and 5ABCD versions of the data:
d3cd <- filter(d, area %in% c("3CD"))
d5ab <- filter(d, area %in% c("5AB"))
d5cd <- filter(d, specific_area %in% c("5C", "5D"))
d5cd$area <- "5CD"
d5abcd <- bind_rows(d5ab, d5cd)
d5abcd$area <- "5ABCD"
d_all <- bind_rows(d3cd, d5ab, d5cd, d5abcd)
rm(d3cd, d5ab, d5cd, d5abcd)

# A data set with the original key localities:
d_loc <- d_all %>%
  filter(locality_description %in% key_locality |
      (year <= 1967 & (specific_area == "5A" | specific_area == "5B")) |
      area == "3CD")

# This should match CPUE analysis D from the last research document:
d_resdoc_2015 <- d_loc %>%
  filter(best_depth_m <= 150) %>%
  group_by(year, area, trip_id, fishing_event_id) %>%
  summarise(
    pcod_catch = sum(ifelse(species_code == "222", total, 0)),
    effort = hours_fished[[1]]) %>%
  group_by(area, year) %>%
  summarise(pcod_catch = sum(pcod_catch), effort = sum(effort)) %>%
  mutate(cpue = pcod_catch / effort) %>%
  mutate(version = "Forrest et al. 2015")

# This version extends the depth filter to 300m, which encompasses most but
# not all Pacific Cod:
d_depth_350 <- d_loc %>%
  filter(best_depth_m <= 350) %>%
  group_by(year, area, trip_id, fishing_event_id) %>%
  summarise(
    pcod_catch = sum(ifelse(species_code == "222", total, 0)),
    effort = hours_fished[[1]]) %>%
  group_by(area, year) %>%
  summarise(pcod_catch = sum(pcod_catch), effort = sum(effort)) %>%
  mutate(cpue = pcod_catch / effort) %>%
  mutate(version = "Depth <= 350")

# This version adds in the key localities only:
d_depth_new_loc <- d_all %>%
  filter(locality_description %in% union(new_locality_2018, key_locality) |
      (year <= 1967 & (specific_area == "5A" | specific_area == "5B")) |
      area == "3CD") %>%
  filter(best_depth_m <= 150) %>%
  group_by(year, area, trip_id, fishing_event_id) %>%
  summarise(
    pcod_catch = sum(ifelse(species_code == "222", total, 0)),
    effort = hours_fished[[1]]) %>%
  group_by(area, year) %>%
  summarise(pcod_catch = sum(pcod_catch), effort = sum(effort)) %>%
  mutate(cpue = pcod_catch / effort) %>%
  mutate(version = "New localities")

# This version adds in the new key localities and new depth:
d_depth_350_new_loc <- d_all %>%
  filter(locality_description %in% union(new_locality_2018, key_locality) |
      (year <= 1967 & (specific_area == "5A" | specific_area == "5B")) |
      area == "3CD") %>%
  filter(best_depth_m <= 350) %>%
  group_by(year, area, trip_id, fishing_event_id) %>%
  summarise(
    pcod_catch = sum(ifelse(species_code == "222", total, 0)),
    effort = hours_fished[[1]]) %>%
  group_by(area, year) %>%
  summarise(pcod_catch = sum(pcod_catch), effort = sum(effort)) %>%
  mutate(cpue = pcod_catch / effort) %>%
  mutate(version = "Depth <= 350 & new localities")
```

```{r cpue-historic-paul}
# The data from the last research document:
paul <- read.csv(here::here("data/cpue/Starr_2013_CPUE.csv"), stringsAsFactors = FALSE) %>%
  rename(year = FYear, area = Area, cpue = CPUE) %>%
  filter(Analysis == "AD") %>%
  select(-Analysis) %>%
  mutate(version = "Paul")

bind_rows(d_resdoc_2015, paul) %>%
  ggplot(aes(year, cpue, colour = version)) +
  facet_wrap(~area) +
  geom_line() +
  gfplot::theme_pbs()
```

```{r cpue-historic-comparison-plot}
cpue <- bind_rows(
  d_resdoc_2015,
  d_depth_350,
  d_depth_new_loc,
  d_depth_350_new_loc
)
filter(cpue, version != "Depth <= 350 & new localities") %>%
  ggplot(aes(year, cpue, colour = version)) +
  facet_wrap(~area) +
  geom_line() +
  gfplot::theme_pbs()
```

```{r save-cpue-data}
saveRDS(cpue, file = here::here("data/pcod-cpue-bridging.rds"))
```
