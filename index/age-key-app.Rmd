\clearpage

`r if(knitr:::is_latex_output()) '\\Appendices'`

`r if(!knitr:::is_latex_output()) '# (APPENDIX) Appendix {-}'`

```{r age-data}
d <- readRDS(file.path(rootd.data, "pcod-cache/pacific-cod.rds"))
```

```{r age-filter}
x <- filter(d$survey_samples,
  is.element(survey_abbrev, c("SYN HS", "SYN QCS","SYN WCVI")))
```

```{r, age-temp, echo=FALSE, eval=FALSE}
xx <- d$commercial_samples %>%
  filter(!is.na(length), sampling_desc == "UNSORTED")

areas <- c("^3[CD]+", "^5[AB]+", "^5[CD]+")
areas <- c("^3[CD]+", "^5[ABCD]+")
xx$area <- NA
for (i in seq_along(areas)) {
  xx[grepl(areas[[i]], xx$major_stat_area_name), "area"] <-
    gsub("\\[|\\]|\\+", "", areas[[i]])
}
xx %>%
  filter(!is.na(area)) %>%
  group_by(area, year) %>%
  filter(year > 1995) %>%
  summarise(
    u = quantile(length, probs = 0.75),
    l = quantile(length, probs = 0.25),
    m = quantile(length, probs = 0.55)
  ) %>%
  ggplot(aes(year, m, ymin = l, ymax = u)) +
  geom_ribbon(alpha = 0.6, aes(fill = area)) +
  geom_line(aes(colour = area), lwd = 1.2)
```


# Age-based analyses for Pacific Cod

- There is very limited ageing data available for BC Pacific Cod populations.

- The delay-difference model is conditional on the assumption that maturity, selectivity to the fishery and selectivity to the survey are all knife-edged at age 2.

- In this appendix we examine length, maturity and available ageing data to test whether these assumptions are likely to be violated.

## Database queries

Survey age, length and maturity data were extracted from the GFBio database using the following query:

In addition, commercial length and maturity samples were extracted from GFBio using the following options:

- Filtered out `TRIP_SUBTYPE_CODE` in 2, 3 (research trips) to extract only commercial data.

- Filtered for `SAMPLE_TYPE_CODE` in 1, 2, 6, 7, 8 (random or total) to extract only those records of sample type 'random' or 'total'.

- Filtered out `TRIP_SUBTYPE_CODE` in 2, 3 (research trips) to extract only commercial data.
- Filtered for `SPECIES_CATEGORY_CODE` NULL, 0, 1, 3, 4, 5, 6, 7 to remove samples sorted on unknown criteria.

- Filtered for `SAMPLE_SOURCE_CODE` NULL, 1, 2, 3 to extract both sorted and unsorted samples for later filtration for desired analysis (removes stomach contents samples).

Note about stratified length samples

```{r age-total_aged}
total_aged <- tidy_ages_raw(x,
  survey = c("SYN HS", "SYN QCS", "SYN WCVI"),
  ageing_method_codes = 6) %>%
  group_by(survey_abbrev, year) %>%
  summarise(n = total[1]) %>% ungroup() %>%
  summarise(n = sum(n)) %>% pull(n)
```

## Age samples

- Pacific Cod are difficult to age due to inconsistency in annual marks, especially in the first few years of life (Beamish, 1981; Johnstone and Anderl, 2012; Kastelle, 2017).

- A recent microchemistry-based validation study of Alaskan Pacific Cod otoliths revealed a high probability of over-ageing fish of ages 3-4 by one year using visual examination methods. This was due to difficulty of readers distinguishing growth checks (translucent zones) from annuli (Kastelle, 2017).

- Pacific Cod are aged in BC using dorsal finray sections, although this method is unvalidated (Beamish, 1981). TEXT FROM JOHN HOLMES REPORT

- Ageing finray sections is resource intensive, since fins must be dried, sectioned and mounted in resin before reading. Therefore, production ageing of Pacific Cod has not been done for BC populations.

- An ageing request was made in 2012 to age Pacific Cod from dorsal fin rays collected in recent synoptic surveys in Areas 3CD, 5AB and 5CD. A total of `r total_aged` fin rays were aged. A summary of number aged by year, survey and sex is provided in Table \@ref(tab:biosamples). Proportions at each age are shown in Figure TODO.

- Due to the difficulties with interpreting annuli for Pacific Cod, a subset of fin rays were read by a second "precision" or secondary reader. There were 162 such secondary reads for Area 5CD and 57 for Area 3CD. Results yielded non-zero probabilities of precision reads differing by one or more years, particularly for older fish (Figure TODO).

- Given the small ranges of years and small sample sizes, these data are insufficient for an age-structured stock assessment.

- However, they may be informative about the assumptions of growth, maturity and selectivity in the delay-difference model.

```{r age-plotages, fig.cap="Figure caption here"}
tidy_ages_raw(x,
  survey = c("SYN HS", "SYN QCS", "SYN WCVI"),
  ageing_method_codes = 6
) %>%
  plot_ages(
    count_label_size = 3, diagonal_lines = seq(-2100, -1850, 2),
    max_size = 12
  ) +
  scale_x_continuous(breaks = 2006:2011) +
  scale_y_continuous(breaks = seq(1, 10)) +
  ggtitle("") +
  ylim(0, NA)
```

```{r age-precision, fig.cap="Aging precision; all samples", fig.asp=1, out.width="3in", fig.width=4}
tidy_age_precision(d$age_precision, ageing_method_codes = 6) %>%
  plot_age_precision(n = 1e6) +
  scale_x_continuous(breaks = seq(0, 10, 1)) +
  scale_y_continuous(breaks = seq(0, 10, 1)) +
  ggtitle("")
```

```{r age-biosamples, results='asis'}
x %>%
  filter(survey_abbrev %in% c("SYN HS", "SYN QCS", "SYN WCVI")) %>%
  filter(!is.na(age)) %>%
  group_by(survey_abbrev, year) %>%
  summarize(
    nage_m = sum(sex == 1),
    nage_f = sum(sex == 2),
    proportion_male = sprintf("%.2f", round(nage_m / (nage_f + nage_m), 2)),
    proportion_female = sprintf("%.2f", round(nage_f / (nage_f + nage_m), 2))
  ) %>%
  rename(
    Survey = survey_abbrev, Year = year, `N male` = nage_m,
    `N female` = nage_f, `Prop. male` = proportion_male,
    `Prop. female` = proportion_female
  ) %>%
  knitr::kable(caption = "Caption for the table", booktabs = TRUE, linesep = "")
```

## Growth

Growth parameters were estimated by fitting age and length data to the von Bertalanffy growth function (Equation \@ref(eq:vB))

\begin{equation}
L_{s} = L_{\infty,s}\left( 1 - e^{- k_{s}\left( a_{s} - {a_{0}}_{s} \right)} \right)
 (\#eq:vB)
\end{equation}

where $L_{\infty,s}$, $k_{s}$ and ${a_{0}}_{s}$ are the parameters of the equation specific to sex, and $L_{s}$ and $a_{s}$ are paired length ($L$) and age ($a$) observations from synoptic surveys (Table \@ref(tab:biosamples)). The model was fit separately for males and females to: (a) all paired age-length samples; (b) Hecate Strait/Queen Charlotte Sound age-length samples; and (c) West Coast Vancouver Island age-length samples. Results are shown in Figure \@ref(fig:vb-figs).

Length-weight parameters (Equation \@ref(eq:weight-length)) were also estimated using paired length and weight data from the same surveys

\begin{equation}
W_{s} = \alpha_{s}{L_{s}}^{\beta_{s}}
 (\#eq:weight-length)
\end{equation}

where $\alpha_s$ and $\beta_s$ are the parameters of the equation specific to sex, and $L_s$ and $W_s$ are paired length ($L$) and weight ($W$) observations from synoptic surveys (Table \@ref(tab:biosamples)). Results are shown in Figure \@ref(fig:lw-figs).

```{r age-fit-vb, results='hide'}
surveys_list <- list(
  `SYN HS, SYN QCS, SYN WCVI` = c("SYN HS", "SYN QCS","SYN WCVI"),
  `SYN HS, SYN QCS` = c("SYN HS", "SYN QCS"),
  `SYN WCVI` = "SYN WCVI"
)
sexes <- c("male", "female")
vb_fits <-
  map(surveys_list, function(.survey) {
    map(sexes, function(.sex) {
      .dat <- filter(x, is.element(survey_abbrev, .survey))
      fit_vb(.dat, .sex, method = "mcmc", chains = 1, uniform_priors = TRUE)
    })
  })
```

```{r age-plot-vb1}
preds <- plyr::ldply(vb_fits, function(.x) bind_rows(data.frame(.x[[1]]$predictions, sex = "male"), data.frame(.x[[2]]$predictions, sex = "female"))) %>% filter(sex == "female")%>% filter(!.id %in% c("SYN HS, SYN QCS, SYN WCVI"))

dats <- plyr::ldply(vb_fits, function(.x) bind_rows(data.frame(.x[[1]]$data), data.frame(.x[[2]]$data))) %>%
  filter(sex == 2) %>% filter(!.id %in% c("SYN HS, SYN QCS, SYN WCVI"))

ggplot(dats, aes(age, length, colour = .id)) +
  geom_point(position = position_jitter(width = 0.15, height = 0), alpha = 0.7) +
  geom_line(data = preds, lwd = 2)

ggplot(dats, aes(as.factor(age), length, fill = .id)) +
  geom_boxplot() +
  geom_line(data = preds, lwd = 2, aes(x = age+1, colour = .id))
```


```{r vb-figs, fig.cap = "Caption", fig.asp=0.3, fig.width=9, out.width="6.5in"}
vb_figs <- map(vb_fits, ~ plot_vb(
  object_male = .x[[1]], object_female = .x[[2]],
      col = c(Female = "red", Male = "grey40"), lab_x = 0.38) +
    ggtitle(paste(unique(.x[[1]]$data$survey_abbrev), collapse = ", ")))
cowplot::plot_grid(plotlist = vb_figs, nrow = 1)
```

```{r age-vb-pars, fig.asp=0.4, fig.cap = "Caption"}
get_par_df <- function(.d, element = 1) {
  map_df(vb_fits, function(.x) {
    broom::tidyMCMC(.x[[element]]$model, conf.int = TRUE, conf.level = 0.9) %>%
    select(-std.error) %>%
    mutate(surveys = paste(unique(.x[[element]]$data$survey_abbrev), collapse = ", ")) %>%
    mutate(Sex = paste(unique(.x[[element]]$data$survey_abbrev), collapse = ", ")) %>%
    mutate(Sex = sexes[element]) %>%
    filter(term != "sigma")
})}
get_par_df(vb_fits, 1) %>%
  bind_rows(get_par_df(vb_fits, 2)) %>%
  mutate(surveys = factor(surveys, levels = rev(names(surveys_list)))) %>%
  ggplot(aes(surveys, estimate, colour = Sex, ymin = conf.low, ymax = conf.high)) +
  geom_pointrange(position = position_dodge(width = 0.2)) +
  facet_wrap(~term, scales = "free_x") +
  coord_flip() +
  ylab("Parameter value") +
  xlab("") +
  theme_pbs() +
  scale_color_manual(values = c("female" = "red", "male" = "grey40"))
```

```{r age-fit-lw, results='hide'}
lw_fits <-
  map(surveys_list, function(.survey) {
    map(sexes, function(.sex) {
      .dat <- filter(x, is.element(survey_abbrev, .survey))
      fit_length_weight(.dat, .sex, method = "rlm")
    })
  })
```

```{r age-lw-figs, fig.cap = "Caption", fig.asp=0.28, fig.width=9, out.width="6.5in"}
lw_figs <- map(lw_fits, ~ plot_length_weight(
  object_male = .x[[1]], object_female = .x[[2]],
      col = c(Female = "red", Male = "grey40"), lab_x_gap = 0.45) +
    ggtitle(paste(unique(.x[[1]]$data$survey_abbrev), collapse = ", ")))
cowplot::plot_grid(plotlist = lw_figs, nrow = 1)
```

```{r age-lw-pars, fig.asp=0.4, fig.cap = "Caption"}
get_par_df <- function(.d, element = 1) {
  map_df(lw_fits, function(.x) {
    broom::tidy(.x[[element]]$model) %>%
    mutate(surveys = paste(unique(.x[[element]]$data$survey_abbrev), collapse = ", ")) %>%
    mutate(Sex = paste(unique(.x[[element]]$data$survey_abbrev), collapse = ", ")) %>%
    mutate(Sex = sexes[element]) %>%
    filter(term != "statistic")
})}
get_par_df(lw_fits, 1) %>%
  bind_rows(get_par_df(lw_fits, 2)) %>%
  mutate(conf.low = estimate - 1.96 * std.error, conf.high = estimate + 1.96 * std.error) %>%
  mutate(surveys = factor(surveys, levels = rev(names(surveys_list)))) %>%
  mutate(term = gsub("\\(Intercept\\)", "ln(a_s)", term)) %>%
  mutate(term = gsub("log\\(length\\)", "b_s", term)) %>%
  ggplot(aes(surveys, estimate, colour = Sex, ymin = conf.low, ymax = conf.high)) +
  geom_pointrange(position = position_dodge(width = 0.2)) +
  facet_wrap(~term, scales = "free_x") +
  coord_flip() +
  ylab("Parameter value") +
  xlab("") +
  theme_pbs() +
  scale_color_manual(values = c("female" = "red", "male" = "grey40"))
```

- Estimates of growth rate $k$ higher in the WCVI survey compared to HS/QCS.

- The 2013 stock assessments for Hecate Strait and Queen Charlotte Sound Pacific Cod stocks (Forrest et al., 2015) used the same growth parameters used in the previous assessment for the Hecate Strait stock, i.e., $L_{\infty}$ = 89.48 cm; $k$ = 0.307 y^-1^ and $a_0$ = -0.116 y (Sinclair and Starr 2004). These values were reported by Westrheim (1996) for the WCVI stock. Westrheim (1996) reported different values for the Hecate Strait stock, i.e., $L_{\infty}$ = 84.01 cm; $k$ = 0.203 y^-1^ and $a_0$ = -0.806 y. In those analyses, age-frequencies were derived from length-frequency data, using the methods described in Foucher and Fournier (1982).

- The current results Figs \@ref(fig:vb-pars) and \@ref(fig:lw-pars), which are based on sampled age and length observations (Table \@ref(tab:biosamples)), are consistent with the parameters reported by Westrheim (1996), where Hecate Strait fish appear to grow more slowly and reach a smaller size compared with those from West Coast Vancouver Island. This suggests that the current assessment should calculate the growth parameters of the delay-difference model using updated von Bertalanffy growth parameters, as the values used in the 2013 assessment may have been too high.

- Comment on sample sizes and imprecision --- insufficient secondary reads to account for ageing error in calculation of growth parameters [e.g., as in @cope2007].

## Maturity

Maturity-at-age parameters were estimated by fitting observed age and maturity data to the logistic function

We fit maturity ogives as logistic regressions of maturity (mature vs. not mature) against length or age:

\begin{align}
y_i &\sim \mathrm{Binomial}(\pi_i)\\
\mathrm{logit} \left( \pi_i \right) &= \beta_0 + \beta_1 x_i + \beta_2 F_i +  \beta_3 x_i F_i
 (\#eq:maturity)
\end{align}

where $y_i$ represents a 1 if fish $i$ is considered mature and a 0 if fish $i$
is considered immature. The $\beta$ parameters represent estimated coefficients,
$x_i$ represents either the length or age of fish $i$, and $F_i$ represents
a binary predictor that is 1 if the fish is female and 0 if the fish is male.
The variable $\pi_i$ represents the expected probability of fish $i$ being
mature. We can then calculate of the age at 50% maturity as: $-(\log(1 / 0.5 - 1) + \beta_0) / \beta_1$ or $-(\log(1) + \beta_0) / \beta_1$ for males and $-(\log(1) + \beta_0 + \beta_2) / (\beta_1 + \beta_3)$ for females.

Maturity for Pacific Cod is assessed by visual inspection of the gonads, where maturity is assigned a code according to Gadid maturity stage. For the purposes of fitting to a logistic curve, maturity was assigned a binary code, where fish with gonad maturity code 3 or higher were defined as mature (maturity assigned 1), and fish with gonad code 1 or 2 were defined as immature (maturity assigned 0).

```{r age-fit-maturity}
surveys_list <- list(
  `SYN HS, SYN QCS, SYN WCVI` = c("SYN HS", "SYN QCS","SYN WCVI"),
  `SYN HS, SYN QCS` = c("SYN HS", "SYN QCS"),
  `SYN WCVI` = "SYN WCVI"
)
mat_fits <- map(surveys_list, function(.survey) {
  .dat <- filter(x, is.element(survey_abbrev, .survey))
  fit_mat_ogive(.dat, type = "age")
})
```

```{r age-mat-figs, fig.cap = "Caption", fig.asp=1.7, fig.width=4.5, out.width="3.4in"}
mat_figs <- map(mat_fits, ~ plot_mat_ogive(.x) +
    coord_cartesian(xlim = c(0, 8.2), ylim = c(0, 1), expand = FALSE))
for (i in seq_along(mat_figs))
  mat_figs[[i]] <- mat_figs[[i]] + ggtitle(names(surveys_list)[i])
cowplot::plot_grid(plotlist = mat_figs, ncol = 1)
```

```{r age-mat-coefs, fig.cap = "Rearranged coefficients from the logistic regression maturity ogives. Parameters are in logit or log odds space. The intercept refers to the log odds of maturity for a theoretical fish of age zero.", fig.width=6, out.width="4.5in"}
mat_coefs <- plyr::ldply(mat_fits, function(.x) {
  broom::tidy(.x$model, conf.int = TRUE)
})

# mutate(mat_coefs, .id = factor(.id, levels = names(surveys_list))) %>%
# ggplot(
#   aes(ymin = conf.low, ymax = conf.high, y = estimate, x = term, colour = .id)) +
#   geom_pointrange(position = position_dodge(width = 0.4)) +
#   coord_flip() +
#   theme_pbs() +
#   xlab("") + ylab("Coefficient") +
#   labs(colour = "Survey group")

est <- group_by(mat_coefs, .id) %>%
  summarise(
    intercept_male = estimate[term == "(Intercept)"],
    intercept_female = estimate[term == "(Intercept)"] + estimate[term == "female"],
    slope_male = estimate[term == "age_or_length"],
    slope_female = estimate[term == "age_or_length"] +
      estimate[term == "age_or_length:female"]
  ) %>% reshape2::melt(variable.name = "term", value.name = "estimate")

combine_se <- function(se1, se2) {
  sqrt(se2^2 - se1^2)
}

se <- group_by(mat_coefs, .id) %>%
  summarise(
    intercept_male = std.error[term == "(Intercept)"],
    intercept_female = combine_se(std.error[term == "(Intercept)"],
      std.error[term == "female"]),
    slope_male = std.error[term == "age_or_length"],
    slope_female = combine_se(std.error[term == "age_or_length"],
      std.error[term == "age_or_length:female"])
  ) %>% reshape2::melt(variable.name = "term", value.name = "std.error")
inner_join(est, se) %>%
  mutate(conf.low = estimate - 1.96 * std.error) %>%
  mutate(conf.high = estimate + 1.96 * std.error) %>%
  mutate(.id = factor(.id, levels = names(surveys_list))) %>%
  ggplot(aes(ymin = conf.low, ymax = conf.high, y = estimate,
    x = term, colour = .id)) +
  geom_pointrange(position = position_dodge(width = 0.4)) +
  coord_flip() +
  theme_pbs() +
  xlab("") + ylab("Coefficient") +
  labs(colour = "Survey group") +
  scale_color_brewer(palette = "Dark2")
```


Estimated parameters are provided in Table TODO Estimated maturity ogives are shown in Figure \@ref(fig:mat-figs). Results suggest that age 3 y may be a more appropriate assumption for knife-edged maturity than age 2. Estimates older for WCVI than HS/QCS.

- RF to check Westrheim report for previous estimates
