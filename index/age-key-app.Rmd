\clearpage


```{r age-data}
d <- readRDS(file.path(rootd.data, "pcod-cache/pacific-cod.rds"))
```

```{r age-filter}
x <- filter(d$survey_samples,
  is.element(survey_abbrev, c("SYN HS", "SYN QCS","SYN WCVI")))
```

```{r length-temp, echo=FALSE, eval=TRUE}
xx <- d$commercial_samples %>%
  dplyr::filter(!is.na(length))

xx <- xx[!duplicated(xx$specimen_id), , drop = FALSE]
xx$area <- gfplot::assign_areas(xx$major_stat_area_name,
 area_regex = c("3[CD]+", "5[ABCD]+"))
```

```{r age-total_aged}
total_aged <- tidy_ages_raw(x,
  survey = c("SYN HS", "SYN QCS", "SYN WCVI"),
  ageing_method_codes = 6) %>%
  group_by(survey_abbrev, year) %>%
  summarise(n = total[1]) %>% ungroup() %>%
  summarise(n = sum(n)) %>% pull(n)
```


```{r length-total_lengths}
total_survey_lengths <- gfplot::tidy_lengths_raw(x,
                       survey = c("SYN HS", "SYN QCS", "SYN WCVI")) %>%
  group_by(survey_abbrev, year) %>%
  summarise(n = total[1]) %>% ungroup() %>%
  summarise(n = sum(n)) %>% pull(n)
```

# ANALYSIS OF BIOLOGICAL DATA

*TO DO: Synoptic survey data section: Add query details for length data (survey and comm). Or maybe here is where description of gfplot goes. *

*TO DO: Commercial fishery data section: Tabulate criteria for commercial data below. Not really clear what it means. See main body and Appendix C of 2013 assessment and update with recent modifications if any.*

*TO DO: Age samples section: add references below to bib and cite correctly.  Add info on length-stratification in surveys.*

*TO DO. General: Improve fig and table captions. Improve figure spacing.*


In this appendix we analyse length, maturity and available ageing data to update growth and maturity parameters. We also plot age-frequency data derived from an age-length key to visualise the probable age composition in survey and commercial catch data.


## LENGTH, WEIGHT AND MATURITY SAMPLES

### SYNOPTIC SURVEY DATA
Length, weight and maturity data from the Hecate Strait, Queen Charlotte Sound and West Coast Vancouver Island synoptic surveys were extracted from the GFBio database using the following criteria in SQL queries ... *TO DO*

A summary of number of fish measured by year, survey and sex is provided in Table \@ref(tab:length-biosamples-surv). Survey length-frequencies are shown in Figure \@ref(fig:length-plotfrequencies-surv).A summary of number of fish weighed by year, survey and sex is provided in Table \@ref(tab:weight-biosamples).A summary of number of maturity records by year and survey is provided in Table \@ref(tab:mat-biosamples).

```{r length-biosamples-surv, results='asis'}

x %>%
  filter(survey_abbrev %in% c("SYN HS", "SYN QCS", "SYN WCVI")) %>%
  filter(!is.na(length)) %>%
  group_by(survey_abbrev, year) %>%
  summarize(
    nlength_m = sum(sex == 1),
    nlength_f = sum(sex == 2),
    nlength_u = sum(sex == 0),
    maxlength_m = max(length[which(sex == 1)], na.rm=T),
    maxlength_f = max(length[which(sex == 2)], na.rm=T),
    maxlength_u = ifelse(nlength_u >0,  max(length[which(sex == 0)], na.rm=T),NA)
  ) %>%
  rename(
     Survey = survey_abbrev, Year = year, `N male` = nlength_m,
     `N female` = nlength_f, `N unsexed` = nlength_u, `Max male (cm)` = maxlength_m, `Max female (cm)` = maxlength_f, `Max unsexed (cm)` = maxlength_u) %>%
  knitr::kable(caption = "Number (N) of length measurements taken in the Hecate Strait (SYN HS), Queen Charlotte Sound (SYN QCS) and West Coast Vancouver Island (SYN WCVI) synoptic surveys", booktabs = TRUE, linesep = "")%>%
  kableExtra::kable_styling(latex_options = c("hold_position"), font_size = 9)
```

```{r weight-biosamples, results='asis'}
x %>%
  filter(survey_abbrev %in% c("SYN HS", "SYN QCS", "SYN WCVI")) %>%
  filter(!is.na(weight)) %>%
  group_by(survey_abbrev, year) %>%
  summarize(
    nweight_m = sum(sex == 1),
    nweight_f = sum(sex == 2),
    nweight_u = sum(sex == 0)

  ) %>%
  rename(
    Survey = survey_abbrev, Year = year, `N male` = nweight_m,
    `N female` = nweight_f, `N unsexed` = nweight_u) %>%
  knitr::kable(caption = "Number (N) of weight measurements taken in the Hecate Strait (SYN HS), Queen Charlotte Sound (SYN QCS) and West Coast Vancouver Island (SYN WCVI) synoptic surveys", booktabs = TRUE, linesep = "")%>%
  kableExtra::kable_styling(font_size = 9)
```


```{r mat-biosamples, results='asis'}
x %>%
  filter(survey_abbrev %in% c("SYN HS", "SYN QCS", "SYN WCVI")) %>%
  filter(!is.na(maturity_code)) %>%
  filter(maturity_convention_code !=9) %>%   #filter out maturities not looked at
  group_by(survey_abbrev, year) %>%
  summarize(
    nmat_m = sum(sex == 1),
    nmat_f = sum(sex == 2)

  ) %>%
  rename(
    Survey = survey_abbrev, Year = year, `N male` = nmat_m,
    `N female` = nmat_f) %>%
  knitr::kable(caption = "Number (N) of maturities recorded in the Hecate Strait (SYN HS), Queen Charlotte Sound (SYN QCS) and West Coast Vancouver Island (SYN WCVI) synoptic surveys", booktabs = TRUE, linesep = "")%>%
  kableExtra::kable_styling(font_size = 9)
```


```{r length-plotfrequencies-surv, fig.cap="Length-frequencies of Pacific Cod taken in the Hecate Strait (SYN HS), Queen Charlotte Sound (SYN QCS) and West Coast Vancouver Island (SYN WCVI) synoptic surveys. Note that for clarity only male and female specimens are plotted."}

 x %>%
  tidy_lengths_raw(survey = c("SYN HS", "SYN QCS", "SYN WCVI"),
  bin_size = 2,
  year_range = c(2002, Inf)) %>%
  plot_lengths()


```

\clearpage

### COMMERCIAL FISHERY DATA
Length data from commercial bottom trawl vessels were extracted from the GFBio database, using the criteria given below. Examination of the sample length frequencies revealed 7 samples that were coded as being Pacific Cod but the size
composition was uncharacteristic of the species. These samples, listed in Table XX, were eliminated from the analysis.

- Filtered out `TRIP_SUBTYPE_CODE` in 2, 3 (research trips) to extract only commercial data.

- Filtered for `SAMPLE_TYPE_CODE` in 1, 2, 6, 7, 8 (random or total) to extract only those records of sample type 'random' or 'total'.

- Filtered out `TRIP_SUBTYPE_CODE` in 2, 3 (research trips) to extract only commercial data.
- Filtered for `SPECIES_CATEGORY_CODE` NULL, 0, 1, 3, 4, 5, 6, 7 to remove samples sorted on unknown criteria.

- Filtered for `SAMPLE_SOURCE_CODE` NULL, 1, 2, 3 to extract both sorted and unsorted samples for later filtration for desired analysis (removes stomach contents samples).

- Filtered out 7 samples ...


Summaries of number of fish measured by year, survey and sex are provided in Tables \@ref(tab:length-biosamples-com-5ABCD) and \@ref(tab:length-biosamples-com-3CD). Commercial length-frequencies are shown in Figure  \@ref(fig:length-plot-frequencies-com).

\clearpage

```{r length-biosamples-com-5ABCD, results='asis'}
xx %>%
  filter(area %in% c("5ABCD")) %>%
  filter(!is.na(length), year > 1955) %>%
  filter(year < 2018) %>%
  group_by(area, year) %>%
  summarize(
    nlength_m = sum(sex == 1),
    nlength_f = sum(sex == 2),
    nlength_u = sum(sex == 0)

  ) %>%
  rename(
    Area = area, Year = year, `N male` = nlength_m,
    `N female` = nlength_f, `N unsexed` = nlength_u ) %>%
  knitr::kable(caption = "Number (N) of length measurements taken in the commercial trawl fishery in Area 5ABCD", booktabs = TRUE, linesep = "", longtable=TRUE)%>%
  kableExtra::kable_styling(latex_options = c("hold_position", "repeat_header"), font_size = 10)
```

\clearpage

```{r length-biosamples-com-3CD, results='asis'}
xx %>%
  filter(area %in% c("3CD")) %>%
  filter(!is.na(length), year > 1955) %>%
  filter(year < 2018) %>%
  group_by(area, year) %>%
  summarize(
    nlength_m = sum(sex == 1),
    nlength_f = sum(sex == 2),
    nlength_u = sum(sex == 0)

  ) %>%
  rename(
    Area = area, Year = year, `N male` = nlength_m,
    `N female` = nlength_f, `N unsexed` = nlength_u ) %>%
  knitr::kable(caption = "Number (N) of length measurements taken in the commercial trawl fishery in Area 3CD", booktabs = TRUE, linesep = "", longtable=TRUE)%>%
  kableExtra::kable_styling(latex_options = c("hold_position", "repeat_header"), font_size = 10)
```

\clearpage

```{r length-plot-frequencies-com, fig.cap="Length-frequencies of Pacific Cod taken in the commercial trawl fishery. For clarity only lengths since 1996 are shown.", fig.asp=1.4}

xx %>%
 filter(!is.na(area)) %>%
 filter(year >= 1996) %>%
  filter(year < 2018) %>%
 filter(species_category_code %in% 1) %>%
 do(gfplot:::bin_lengths(., value = length, bin_size = 2)) %>%
 rename(length_bin = length) %>%
 group_by(year, length_bin, area) %>%
 summarise(n = n()) %>%
 group_by(year, area) %>%
 mutate(proportion = n / sum(n), total = sum(n)) %>%
 ungroup() %>%
 mutate(sex = "M", survey_abbrev = area) %>% # sex = "M" is a trick to plot them all
 plot_lengths() + xlab("Length (cm)") +
 guides(colour = FALSE, fill = FALSE)


```


\clearpage


## AGE SAMPLES

Pacific Cod are difficult to age due to inconsistency in annual marks, especially in the first few years of life (Beamish, 1981; Johnstone and Anderl, 2012; Kastelle, 2017).A recent microchemistry-based validation study of Alaskan Pacific Cod otoliths revealed that visual aging of otoliths resulted in a high probability of over-ageing fish of ages 3-4 y. This was due to difficulty of readers distinguishing growth checks (translucent zones) from annuli (Kastelle, 2017). Due to large difficulties in interpreting growth patterns on otoliths from BC Pacific Cod, they are here aged using dorsal finray sections, although this method is unvalidated (Beamish, 1981). Ageing finray sections is resource intensive, since fins must be dried, sectioned and mounted in resin before reading. Therefore, production ageing of Pacific Cod has not been routinely done for BC populations.

A request was made in 2012 to age Pacific Cod from dorsal fin rays collected in recent Hecate Strait, Queen Charlotte Sound and West Coast Vancouver Island synoptic surveys. A total of `r total_aged` fin rays were aged, covering the years 2007, 2009, 2011 for SYN HS; 2011 for SYN QCS and 2006, 2008 and 2010 for SYN WCVI. A summary of number of fish aged by year, survey and sex is provided in Table \@ref(tab:age-biosamples). Proportions at each age are shown in Figure \@ref(fig:age-plotages).

Due to the difficulties with interpreting annuli for Pacific Cod, a subset of fin rays were read by a second reader. There were 162 such secondary reads for Area 5CD and 57 for Area 3CD. Results showed that precision reads sometimes differed from the primary read by one or more years, particularly for older fish (Figure \@ref(fig:age-precision)).

Given the small ranges of years with aged fish, these data are insufficient to support an age-structured stock assessment model. However, they can be used to estimate growth and maturity parameters, and may be useful for visualizing probable age compositions in the commercial catch data.

\clearpage

```{r age-biosamples, results='asis'}
x %>%
  filter(survey_abbrev %in% c("SYN HS", "SYN QCS", "SYN WCVI")) %>%
  filter(!is.na(age)) %>%
  group_by(survey_abbrev, year) %>%
  summarize(
    nage_m = sum(sex == 1),
    nage_f = sum(sex == 2) #,
    #proportion_male = sprintf("%.2f", round(nage_m / (nage_f + nage_m), 2)),
    #proportion_female = sprintf("%.2f", round(nage_f / (nage_f + nage_m), 2))
  ) %>%
  rename(
    Survey = survey_abbrev, Year = year, `N male` = nage_m,
    `N female` = nage_f #,
    #`P male` = proportion_male,
    #`P female` = proportion_female
  ) %>%
  knitr::kable(caption = "Numbers (N) of otoliths aged in the Hecate Strait (SYN HS), Queen Charlotte Sound (SYN QCS) and West Coast Vancouver Island (SYN WCVI) synoptic surveys", booktabs = TRUE, linesep = "")
```

```{r age-plotages, fig.cap="Proportions at age of fish aged in the Hecate Strait (SYN HS), Queen Charlotte Sound (SYN QCS) and West Coast Vancouver Island (SYN WCVI) synoptic surveys. Grey circles = males. Red circles = females."}
tidy_ages_raw(x,
  survey = c("SYN HS", "SYN QCS", "SYN WCVI"),
  ageing_method_codes = 6
) %>%
  plot_ages(
    count_label_size = 3, diagonal_lines = seq(-2100, -1850, 2),
    max_size = 12
  ) +
  scale_x_continuous(breaks = 2006:2011) +
  scale_y_continuous(breaks = seq(1, 10)) +
  ggtitle("") +
  ylim(0, NA)
```


```{r age-precision, fig.cap="Aging precision; all samples", fig.asp=1, out.width="3in", fig.width=4}
tidy_age_precision(d$age_precision, ageing_method_codes = 6) %>%
  plot_age_precision(n = 1e6) +
  scale_x_continuous(breaks = seq(0, 10, 1)) +
  scale_y_continuous(breaks = seq(0, 10, 1)) +
  ggtitle("")
```

\clearpage

## GROWTH PARAMETERS

Growth parameters were estimated by fitting age and length data to the von Bertalanffy growth function (Equation \@ref(eq:vB))

\begin{equation}
L_{s} = L_{\infty,s}\left( 1 - e^{- k_{s}\left( a_{s} - {a_{0}}_{s} \right)} \right)
 (\#eq:vB)
\end{equation}

where $L_{\infty,s}$, $k_{s}$ and ${a_{0}}_{s}$ are the parameters of the equation specific to sex, and $L_{s}$ and $a_{s}$ are paired length ($L$) and age ($a$) observations from synoptic surveys (Tables  \@ref(tab:length-biosamples-surv) and \@ref(tab:age-biosamples)).

The model was fit separately for males and females to: (a) all paired age-length samples; (b) Hecate Strait/Queen Charlotte Sound age-length samples; and (c) West Coast Vancouver Island age-length samples (Figures  \@ref(fig:vb-figs) and \@ref(fig:age-vb-pars); Table \@ref(tab:age-coeff-table)). Hecate Strait and Queen Charlotte Sound samples were combined because there was only one year of age observations (2011) for Queen Charlotte Sound (Table \@ref(tab:age-biosamples)). 

*TO DO: Use proper notation in coefficients table (term column: linf, k, t0. RF not good enough at ////regular////expressions!*


\clearpage

```{r age-fit-vb, results='hide'}
surveys_list <- list(
  `SYN HS, SYN QCS, SYN WCVI` = c("SYN HS", "SYN QCS","SYN WCVI"),
  `SYN HS, SYN QCS` = c("SYN HS", "SYN QCS"),
  `SYN WCVI` = "SYN WCVI"
)
sexes <- c("male", "female")
vb_fits <-
  map(surveys_list, function(.survey) {
    map(sexes, function(.sex) {
      .dat <- filter(x, is.element(survey_abbrev, .survey))
      fit_vb(.dat, .sex, method = "mcmc", chains = 1, uniform_priors = TRUE)
    })
  })
```

\clearpage

```{r age-coeff-table, results='asis'}
  get_par_df <- function(.d, element = 1) {
  map_df(vb_fits, function(.x) {
    broom::tidyMCMC(.x[[element]]$model, conf.int = TRUE, conf.level = 0.9) %>%
    select(-std.error) %>%
    mutate(Surveys = paste(unique(.x[[element]]$data$survey_abbrev), collapse = ", ")) %>%
    mutate(Sex = paste(unique(.x[[element]]$data$survey_abbrev), collapse = ", ")) %>%
    mutate(Sex = sexes[element]) %>%
    filter(term != "sigma")
})}
  get_par_df(vb_fits, 1) %>%
  bind_rows(get_par_df(vb_fits, 2)) %>%
  mutate(Surveys = factor(Surveys, levels = rev(names(surveys_list))))     %>%
  rename(Term = term, Estimate = estimate, Conf.low = conf.low, Conf.high = conf.high) %>%
  dplyr::select(Surveys,Sex,Term, Estimate, Conf.low, Conf.high) %>% 
  knitr::kable(caption = "von Bertalanffy growth coefficients for Pacific Cod in the Hecate Strait (SYN HS), Queen Charlotte Sound (SYN QCS) and West Coast Vancouver Island (SYN WCVI) synoptic surveys", booktabs = TRUE, linesep = "", digits=3)

```


```{r vb-figs, fig.cap = "Caption for vb model fits", fig.asp=0.3, fig.width=9, out.width="6.5in"}
vb_figs <- map(vb_fits, ~ plot_vb(
  object_male = .x[[1]], object_female = .x[[2]],
      col = c(Female = "red", Male = "grey40"), lab_x = 0.38) +
    ggtitle(paste(unique(.x[[1]]$data$survey_abbrev), collapse = ", ")))
cowplot::plot_grid(plotlist = vb_figs, nrow = 1)
```


```{r age-vb-pars, fig.asp=0.4, fig.cap = "Caption for coeffcients"}
get_par_df <- function(.d, element = 1) {
  map_df(vb_fits, function(.x) {
    broom::tidyMCMC(.x[[element]]$model, conf.int = TRUE, conf.level = 0.9) %>%
    select(-std.error) %>%
    mutate(surveys = paste(unique(.x[[element]]$data$survey_abbrev), collapse = ", ")) %>%
    mutate(Sex = paste(unique(.x[[element]]$data$survey_abbrev), collapse = ", ")) %>%
    mutate(Sex = sexes[element]) %>%
    filter(term != "sigma")
})}
get_par_df(vb_fits, 1) %>%
  bind_rows(get_par_df(vb_fits, 2)) %>%
  mutate(surveys = factor(surveys, levels = rev(names(surveys_list))))  %>%
  ggplot(aes(surveys, estimate, colour = Sex, ymin = conf.low, ymax = conf.high)) +
  geom_pointrange(position = position_dodge(width = 0.2)) +
  facet_wrap(~term, scales = "free_x") +
  coord_flip() +
  ylab("Parameter value") +
  xlab("") +
  theme_pbs() +
  scale_color_manual(values = c("female" = "red", "male" = "grey40"))
```

Estimates of the von Bertalanffy growth rate $k$ were higher in the WCVI survey (male $k$ = 0.264 y^-1^; female $k$ = 0.265 y^-1^) compared to estimates of $k$ from the HS-QCS  surveys combined (male $k$ = 0.208 y^-1^; female $k$ = 0.184 y^-1^), and all surveys combined (male $k$ = 0.230 y^-1^; female $k$ = 0.208 y^-1^) (Table \@ref(tab:age-coeff-table)). The 2013 stock assessments for Hecate Strait and Queen Charlotte Sound [@forrest2013] used the same growth parameters that had been used in the 2004 assessment for Hecate Strait ($L_{\infty}$ = 89.48 cm; $k$ = 0.307 y^-1^ and $a_0$ = -0.116 y [@sinclair2005]). These values had been reported by @westrheim1996 for the WCVI stock, based on analyses of length-frequency data [@foucher1982]. @westrheim1996 had actually reported a lower growth rate for the Hecate Strait stock, i.e., $k$ = 0.203 y^-1^.  

The current results for Hecate Strait (Table \@ref(tab:age-coeff-table)), are consistent with the parameters reported by @westrheim1996. This suggests that the growth rate use in the delay difference models in @forrest2013 and @sinclair2005 may have been too high for the Hecate Strait stock. The current Base Case models therefore uses the growth parameters reported for females in Table \@ref(tab:age-coeff-table), i.e., "SYN HS, SYN QCS" for Area 5ABCD; and "SYN WCVI" for the 3CD stocks.

*TO DO IF TIME: Comment on sample sizes and imprecision --- insufficient secondary reads to account for ageing error in calculation of growth parameters [e.g., as in @cope2007].*

\clearpage

Length-weight parameters (Equation \@ref(eq:weight-length)) were estimated using paired length and weight data from the synoptic surveys.

\begin{equation}
W_{s} = \alpha_{s}{L_{s}}^{\beta_{s}}
 (\#eq:weight-length)
\end{equation}

where $\alpha_s$ and $\beta_s$ are the parameters of the equation specific to sex, and $L_s$ and $W_s$ are paired length ($L$) and weight ($W$) observations from synoptic surveys (Tables  \@ref(tab:length-biosamples-surv) and \@ref(tab:weight-biosamples)). As for the growth parameters, Equation \@ref(eq:weight-length) was evaluated using data from all surveys combined; the HS-QCS  surveys combined; and the WCVI survey (Figures \@ref(fig:age-lw-figs) and \@ref(fig:age-lw-pars), Table \@ref(tab:lw-coeff-table)).


```{r age-fit-lw, results='hide'}
lw_fits <-
  map(surveys_list, function(.survey) {
    map(sexes, function(.sex) {
      .dat <- filter(x, is.element(survey_abbrev, .survey))
      fit_length_weight(.dat, .sex, method = "rlm")
    })
  })
```


```{r lw-coeff-table}
get_par_df <- function(.d, element = 1) {
  map_df(lw_fits, function(.x) {
    broom::tidy(.x[[element]]$model) %>%
    mutate(Surveys = paste(unique(.x[[element]]$data$survey_abbrev), collapse = ", ")) %>%
    mutate(Sex = paste(unique(.x[[element]]$data$survey_abbrev), collapse = ", ")) %>%
    mutate(Sex = sexes[element]) %>%
    filter(term != "statistic")
})}
get_par_df(lw_fits, 1) %>%
  bind_rows(get_par_df(lw_fits, 2)) %>%
  mutate(Conf.low = estimate - 1.96 * std.error, Conf.high = estimate + 1.96 * std.error) %>%
  mutate(Surveys = factor(Surveys, levels = rev(names(surveys_list)))) %>%
  mutate(term = gsub("\\(Intercept\\)", "$ln(\\\\alpha_s)$", term)) %>%
  mutate(term = gsub("log\\(length\\)", "$\\\\beta_s$", term)) %>%
  rename(Term = term, Estimate = estimate) %>%
  dplyr::select(Surveys,Sex,Term, Estimate, Conf.low, Conf.high) %>% 
  knitr::kable(caption = "Length-weight coefficients for Pacific Cod in the Hecate Strait (SYN HS), Queen Charlotte Sound (SYN QCS) and West Coast Vancouver Island (SYN WCVI) synoptic surveys", booktabs = TRUE, linesep = "", digits=2, escape=FALSE)
```


```{r age-lw-figs, fig.cap = "Length-weight fits ...", fig.asp=0.28, fig.width=9, out.width="6.5in"}
lw_figs <- map(lw_fits, ~ plot_length_weight(
  object_male = .x[[1]], object_female = .x[[2]],
      col = c(Female = "red", Male = "grey40"), lab_x_gap = 0.45) +
    ggtitle(paste(unique(.x[[1]]$data$survey_abbrev), collapse = ", ")))
cowplot::plot_grid(plotlist = lw_figs, nrow = 1)
```

```{r age-lw-pars, fig.asp=0.4, fig.cap = "Length-weight coefficients ..."}
get_par_df <- function(.d, element = 1) {
  map_df(lw_fits, function(.x) {
    broom::tidy(.x[[element]]$model) %>%
    mutate(surveys = paste(unique(.x[[element]]$data$survey_abbrev), collapse = ", ")) %>%
    mutate(Sex = paste(unique(.x[[element]]$data$survey_abbrev), collapse = ", ")) %>%
    mutate(Sex = sexes[element]) %>%
    filter(term != "statistic")
})}
get_par_df(lw_fits, 1) %>%
  bind_rows(get_par_df(lw_fits, 2)) %>%
  mutate(conf.low = estimate - 1.96 * std.error, conf.high = estimate + 1.96 * std.error) %>%
  mutate(surveys = factor(surveys, levels = rev(names(surveys_list)))) %>%
  mutate(term = gsub("\\(Intercept\\)", "ln(a_s)", term)) %>%
  mutate(term = gsub("log\\(length\\)", "b_s", term)) %>%
  ggplot(aes(surveys, estimate, colour = Sex, ymin = conf.low, ymax = conf.high)) +
  geom_pointrange(position = position_dodge(width = 0.2)) +
  facet_wrap(~term, scales = "free_x") +
  coord_flip() +
  ylab("Parameter value") +
  xlab("") +
  theme_pbs() +
  scale_color_manual(values = c("female" = "red", "male" = "grey40"))
```

\clearpage

## MATURITY PARAMETERS

Maturity for Pacific Cod is assessed by visual inspection of the gonads, where maturity is assigned a code according to Gadid maturity stage.Fish are assessed as being in one of six states: 1.immature; 2.maturing; 3.mature (resting); 4.mature; 5.mature (spent); and 6.mature (ripe). For the purposes of fitting to a logistic curve, maturity was assigned a binary code, where fish with gonad maturity code 3 or higher were defined as mature (maturity assigned 1), and fish with gonad code 1 or 2 were defined as immature (maturity assigned 0).

We fit maturity ogives as logistic regressions of maturity (mature vs. not mature) against length or age:

\begin{align}
y_i &\sim \mathrm{Binomial}(\pi_i)\\
\mathrm{logit} \left( \pi_i \right) &= \beta_0 + \beta_1 x_i + \beta_2 F_i +  \beta_3 x_i F_i
 (\#eq:maturity)
\end{align}

where $y_i$ represents a 1 if fish $i$ is considered mature and a 0 if fish $i$
is considered immature. The $\beta$ parameters represent estimated coefficients,
$x_i$ represents the age of fish $i$, and $F_i$ represents
a binary predictor that is 1 if the fish is female and 0 if the fish is male.
The variable $\pi_i$ represents the expected probability of fish $i$ being
mature. We can then calculate of the age at 50% maturity as: $-(\log(1 / 0.5 - 1) + \beta_0) / \beta_1$ or $-(\log(1) + \beta_0) / \beta_1$ for males and $-(\log(1) + \beta_0 + \beta_2) / (\beta_1 + \beta_3)$ for females.

Estimated parameters are provided in Tables \@ref(tab:mat-fifty-tab) and \@ref(tab:age-mat-coefs-table), and Figure \@ref(fig:age-mat-coefs). Estimated maturity ogives are shown in Figure \@ref(fig:age-mat-figs).

*TO DO: Use proper notation in coefficients table (term column: intercept_male, slope_male etc ... convert to betas. RF not good enough at ////regular////expressions!*

*TO DO: update mat-fifty-tab with coefficients directly from fit_mat_ogive. See Slack conversation #pcod Sept 5*

Results suggest that age 3 y may be a more appropriate assumption for knife-edged maturity than age 2 y.

```{r age-fit-maturity}
surveys_list <- list(
  `SYN HS, SYN QCS, SYN WCVI` = c("SYN HS", "SYN QCS","SYN WCVI"),
  `SYN HS, SYN QCS` = c("SYN HS", "SYN QCS"),
  `SYN WCVI` = "SYN WCVI"
)
mat_fits <- map(surveys_list, function(.survey) {
  .dat <- filter(x, is.element(survey_abbrev, .survey))
  fit_mat_ogive(.dat, type = "age")
})
```

\clearpage

```{r age-mat-coefs-table, results='asis'}

mat_coefs <- plyr::ldply(mat_fits, function(.x) {
  broom::tidy(.x$model, conf.int = TRUE)
})

est <- group_by(mat_coefs, .id) %>%
  summarise(
    intercept_male = estimate[term == "(Intercept)"],
    intercept_female = estimate[term == "(Intercept)"] + estimate[term == "female"],
    slope_male = estimate[term == "age_or_length"],
    slope_female = estimate[term == "age_or_length"] +
    estimate[term == "age_or_length:female"]
  ) %>% reshape2::melt(variable.name = "term", value.name = "estimate")

combine_se <- function(se1, se2) {
  sqrt(se2^2 - se1^2)
}

se <- group_by(mat_coefs, .id) %>%
  summarise(
    intercept_male = std.error[term == "(Intercept)"],
    intercept_female = combine_se(std.error[term == "(Intercept)"],
      std.error[term == "female"]),
    slope_male = std.error[term == "age_or_length"],
    slope_female = combine_se(std.error[term == "age_or_length"],
      std.error[term == "age_or_length:female"])
  ) %>% reshape2::melt(variable.name = "term", value.name = "std.error")
inner_join(est, se) %>%
  mutate(.id = factor(.id, levels = names(surveys_list))) %>% 
  mutate(Conf.low = estimate - 1.96 * std.error, Conf.high = estimate + 1.96 * std.error) %>%
  rename(Survey = .id, Term = term, Estimate = estimate) %>%  
  dplyr::select(Survey,Term, Estimate, Conf.low, Conf.high) %>% 
   knitr::kable(caption = "coefficients from the logistic regression maturity ogives", 
     booktabs = TRUE, linesep = "", digits=2)

```


```{r mat-fifty-tab, results = 'asis'}
plyr::ldply(mat_fits, function(.x)
  data.frame(Female = .x$mat_perc$f.p0.5, Male = .x$mat_perc$m.p0.5)) %>%
  melt() %>% 
  mutate(.id = factor(.id, levels = names(surveys_list))) %>% 
  rename(Survey = .id, Sex = variable, `Estimated age-at-50% maturity` = value) %>% 
  arrange(Survey, Sex) %>%
  knitr::kable(
    caption = "Estimates of age at 50 per cent maturity from the logistic regression maturity ogives.", booktabs = TRUE, linesep = "", digits=1)
  
```

\clearpage

```{r age-mat-figs, fig.cap = "Age at maturity ...", fig.asp=1.7, fig.width=4.5, out.width="3.4in"}
mat_figs <- map(mat_fits, ~ plot_mat_ogive(.x) +
    coord_cartesian(xlim = c(0, 8.2), ylim = c(0, 1), expand = FALSE))
for (i in seq_along(mat_figs))
  mat_figs[[i]] <- mat_figs[[i]] + ggtitle(names(surveys_list)[i])
cowplot::plot_grid(plotlist = mat_figs, ncol = 1)
```



```{r age-mat-coefs, fig.cap = "Rearranged coefficients from the logistic regression maturity ogives. Parameters are in logit or log odds space. The intercept refers to the log odds of maturity for a theoretical fish of age zero.", fig.width=6, out.width="4.5in"}

#based on outputs from age-mat-coefs-table

inner_join(est, se) %>%
  mutate(conf.low = estimate - 1.96 * std.error) %>%
  mutate(conf.high = estimate + 1.96 * std.error) %>%
  mutate(.id = factor(.id, levels = names(surveys_list))) %>%
  ggplot(aes(ymin = conf.low, ymax = conf.high, y = estimate,
    x = term, colour = .id)) +
  geom_pointrange(position = position_dodge(width = 0.4)) +
  coord_flip() +
  theme_pbs() +
  xlab("") + ylab("Coefficient") +
  labs(colour = "Survey group") +
  scale_color_brewer(palette = "Dark2")

```

## MEAN WEIGHT IN COMMERCIAL CATCH

*TO DO*

## AGE-LENGTH KEYS
For illustrative purposes, age-length keys (ALKs) were constructed using age and length data from the Hecate Strait, Queen Charlotte Sound and West Coast Vancouver Island Synoptic surveys. 

For each area (3CD and 5ABCD), for each year in which age samples were available, the ALK was used to probabilistically “assign” ages to observed lengths from synoptic surveys and commercial catch data, using methods described in Isermann and Knight (2005), coded in the R package FSA (Ogle, 2012; 2018). 

### STEPS

#### 1. Get the "age sample"" and construct the ALK
The “age sample” contains all the specimen records with *both* an age (y) and length (cm) observations. Age samples are made using data from: 1. the Hecate Strait and Queen Charlotte Sound Synoptic surveys combined; and 2.the West Coast Vancouver Island Synoptic Survey.

```{r, echo=TRUE}

#Filter the survey data then get age sample, then get age-length key (ALK)
#one ALK per year
#5ABCD
yrs <- c(2007,2009,2011)
alk_listHQ <- list()
for(i in seq_along(yrs)){
  pcod.age <- x %>% 
    get_age_sample(surveys = c("SYN HS", "SYN QCS"),alkyr=c(yrs[i])) %>% 
    get_ALK(bin=2) 
    alk_listHQ[[i]] <- pcod.age
}

#3CD
yrs <- c(2006,2008,2010)
alk_listWC <- list()
for(i in seq_along(yrs)){
  pcod.age <- x %>% 
    get_age_sample(surveys = c("SYN WCVI"),alkyr=c(yrs[i])) %>% 
    get_ALK(bin=2) 
    alk_listWC[[i]] <- pcod.age
}

```

