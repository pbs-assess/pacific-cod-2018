\clearpage


```{r age-data}
d <- readRDS(file.path(rootd.data, "pcod-cache/pacific-cod.rds"))
```

```{r age-filter}
x <- filter(d$survey_samples,
  is.element(survey_abbrev, c("SYN HS", "SYN QCS","SYN WCVI")))
```

```{r length-temp, echo=FALSE, eval=TRUE}
xx <- d$commercial_samples %>%
  dplyr::filter(!is.na(length))

xx <- xx[!duplicated(xx$specimen_id), , drop = FALSE]
xx$area <- gfplot::assign_areas(xx$major_stat_area_name,
 area_regex = c("3[CD]+", "5[ABCD]+"))
```

```{r age-total_aged}
total_aged <- tidy_ages_raw(x,
  survey = c("SYN HS", "SYN QCS", "SYN WCVI"),
  ageing_method_codes = 6) %>%
  group_by(survey_abbrev, year) %>%
  summarise(n = total[1]) %>% ungroup() %>%
  summarise(n = sum(n)) %>% pull(n)
```


```{r length-total_lengths}
total_survey_lengths <- gfplot::tidy_lengths_raw(x,
                       survey = c("SYN HS", "SYN QCS", "SYN WCVI")) %>%
  group_by(survey_abbrev, year) %>%
  summarise(n = total[1]) %>% ungroup() %>%
  summarise(n = sum(n)) %>% pull(n)
```

# ANALYSE DES DONNÉES BIOLOGIQUES

Dans cette annexe, nous analysons les données sur la longueur et la maturité, ainsi que les données disponibles sur la détermination de l’âge pour mettre à jour les paramètres de croissance et de maturité. Nous traçons également les courbes des données sur la fréquence selon l’âge dérivées d’une clé âge-longueur pour visualiser la composition probable selon l’âge dans les données des relevés et les données sur les prises commerciales.

## DONNÉES DES RELEVÉS SYNOPTIQUES

Nous avons extrait de la base de données GFBio les données sur la longueur, le poids et la maturité tirées des relevés synoptiques réalisés dans le détroit d’Hécate, le bassin de la Reine-Charlotte et sur la côte ouest de l’île de Vancouver en utilisant les critères suivants :


1. `SPECIES_CODE` = 222 : morue du Pacifique.

1. `TRIP_SUB_TYPE_CODE` = 2 ou 3 : sorties de recherche.

1. `SAMPLE_TYPE_CODE` = 1, 2, 6, 7, ou 8 : inclure seulement les échantillons qui sont de type « aléatoire » ou « total ».

1. `SPECIES_CATEGORY_CODE` = NULL, 1, 3, 5, 6, ou 7 : pour éliminer les échantillons triés selon des critères inconnus.

1. `SAMPLE_SOURCE_CODE` = NULL, 1, 2 : pour extraire les échantillons triés et non triés, mais en retirer les échantillons de contenus stomacaux.

Un récapitulatif du nombre de poissons mesurés par année, relevé et sexe est fourni dans le tableau \@ref(tab:length-biosamples-surv). Les fréquences selon la longueur dans les relevés sont indiquées sur la figure \@ref(fig:length-plotfrequencies-surv). Un récapitulatif du nombre de poissons pesés par année, relevé et sexe est fourni dans le tableau \@ref(tab:weight-biosamples). Un récapitulatif du nombre d’enregistrements de la maturité par année et relevé est fourni dans le tableau \@ref(tab:mat-biosamples).

```{r length-biosamples-surv, results='asis'}
# TODO: get translation for unsexed, Max and Min.
x %>%
  filter(survey_abbrev %in% c("SYN HS", "SYN QCS", "SYN WCVI")) %>%
  filter(!is.na(length)) %>%
  group_by(survey_abbrev, year) %>%
  summarize(
    nlength_m = sum(sex == 1),
    nlength_f = sum(sex == 2),
    nlength_u = sum(sex == 0),
    maxlength_m = max(length[which(sex == 1)], na.rm=T),
    maxlength_f = max(length[which(sex == 2)], na.rm=T),
    maxlength_u = ifelse(nlength_u >0,  max(length[which(sex == 0)], na.rm=T),NA)
  ) %>%
  rename(
     Survey = survey_abbrev, Year = year, `N male` = nlength_m,
     `N female` = nlength_f, `N unsexed` = nlength_u, `Max male (cm)` = maxlength_m, `Max female (cm)` = maxlength_f, `Max unsexed (cm)` = maxlength_u) %>%
  purrr::set_names(en2fr(colnames(.), translate=french, allow_missing=T)) %>% 
  knitr::kable(caption = "Nombre (N) de mesures de longueur prises lors des relevés synoptiques effectués dans le détroit d’Hécate (SYN HS), le bassin de la Reine-Charlotte (SYN QCS) et sur la côte ouest de l’île de Vancouver (SYN WCVI)", booktabs = TRUE, linesep = "", format = "pandoc")%>%
  kableExtra::kable_styling(latex_options = c("hold_position"), font_size = 9)
```

```{r weight-biosamples, results='asis'}
x %>%
  filter(survey_abbrev %in% c("SYN HS", "SYN QCS", "SYN WCVI")) %>%
  filter(!is.na(weight)) %>%
  group_by(survey_abbrev, year) %>%
  summarize(
    nweight_m = sum(sex == 1),
    nweight_f = sum(sex == 2),
    nweight_u = sum(sex == 0)

  ) %>%
  rename(
    Survey = survey_abbrev, Year = year, `N male` = nweight_m,
    `N female` = nweight_f, `N unsexed` = nweight_u) %>%
  knitr::kable(caption = "Nombre (N) de mesures de poids prises lors des relevés synoptiques effectués dans le détroit d’Hécate (SYN HS), le bassin de la Reine-Charlotte (SYN QCS) et sur la côte ouest de l’île de Vancouver (SYN WCVI).", booktabs = TRUE, linesep = "", format = "pandoc")%>%
  kableExtra::kable_styling(font_size = 9)
```

```{r mat-biosamples, results='asis'}
x %>%
  filter(survey_abbrev %in% c("SYN HS", "SYN QCS", "SYN WCVI")) %>%
  filter(!is.na(maturity_code)) %>%
  filter(maturity_convention_code !=9) %>%   #filter out maturities not looked at
  group_by(survey_abbrev, year) %>%
  summarize(
    nmat_m = sum(sex == 1),
    nmat_f = sum(sex == 2)

  ) %>%
  rename(
    Survey = survey_abbrev, Year = year, `N male` = nmat_m,
    `N female` = nmat_f) %>%
  knitr::kable(caption = "Nombre (N) de maturité enregistrées lors des relevés synoptiques effectués dans le détroit d’Hécate (SYN HS), le bassin de la Reine-Charlotte (SYN QCS) et sur la côte ouest de l’île de Vancouver (SYN WCVI).", booktabs = TRUE, linesep = "", format = "pandoc")%>%
  kableExtra::kable_styling(font_size = 9)
```

```{r length-plotfrequencies-surv, fig.cap="Fréquences de longueur de la morue du Pacifique prises lors des relevés synoptiques effectués dans le détroit d’Hécate (SYN HS), le bassin de la Reine-Charlotte (SYN QCS) et sur la côte ouest de l’île de Vancouver (SYN WCVI). Il convient de noter que seuls les spécimens mâles et femelles sont représentés sur le graphique."}

 x %>%
  tidy_lengths_raw(survey = c("SYN HS", "SYN QCS", "SYN WCVI"),
  bin_size = 2,
  year_range = c(2002, Inf)) %>%
  plot_lengths()


```

\clearpage

## DONNÉES DE LA PÊCHE COMMERCIALE

Nous avons extrait de la base de données GFBio les données sur la longueur et le poids communiquées par les chalutiers commerciaux en utilisant les critères suivants :

1. `SPECIES_CODE` = 222 : morue du Pacifique.

1. `TRIP_SUB_TYPE_CODE` = 1 ou 4 : 1 = sans observateur, au pays; 4 = avec observateur, au pays.

1. `GEAR_CODE` = 1 : Chalut de fond.

1. `SAMPLE_TYPE_CODE` = 1, 2, 6, 7, ou 8 : inclure seulement les échantillons qui sont de type « aléatoire » ou « total ».

1. `SPECIES_CATEGORY_CODE` = NULL, 1, 3, 5, 6, ou 7 : pour éliminer les échantillons triés selon des critères inconnus.

1. `SAMPLE_SOURCE_CODE` = NULL, 1, 2, 3 : pour extraire les échantillons triés et non triés, mais en retirer les échantillons de contenus stomacaux.

1. « SAMPLE_ID » pas en 173726, 173740, 191471, 184243, 184159, 215903 ou 223726; ces échantillons ont été codés comme étant de la morue du Pacifique, mais la composition selon la taille ne correspond pas à l’espèce. Ces échantillons ont donc été exclus du reste de l’analyse.

1. Année de pêche : Du 1er avril au 31 mars d’après `trip_start_date`.

1. Trimestre : mois 4-6 = 1, mois 7-9 = 2, mois 10-12 = 3, mois 1-3 = 4.

Un récapitulatif du nombre de poissons mesurés par année, relevé et sexe est fourni dans les tableaux \@ref(tab:length-biosamples-com-5ABCD) et \@ref(tab:length-biosamples-com-3CD). Les fréquences selon la longueur dans les pêches commerciales sont indiquées sur la figure \@ref(fig:length-plot-frequencies-com).

\clearpage

```{r length-biosamples-com-5ABCD, results='asis'}
xx %>%
  filter(area %in% c("5ABCD")) %>%
  filter(!is.na(length), year > 1955) %>%
  filter(year < 2018) %>%
  group_by(area, year) %>%
  summarize(
    nlength_m = sum(sex == 1),
    nlength_f = sum(sex == 2),
    nlength_u = sum(sex == 0)

  ) %>%
  rename(
    Area = area, Year = year, `N male` = nlength_m,
    `N female` = nlength_f, `N unsexed` = nlength_u ) %>%
  knitr::kable(caption = "Nombre (N) de mesures de longueur prises dans la pêche commerciale au chalut dans la zone 5ABCD.", booktabs = TRUE, format = "pandoc", linesep = "", longtable=TRUE)%>%
  kableExtra::kable_styling(latex_options = c("hold_position", "repeat_header"), font_size = 10)
```

\clearpage

```{r length-biosamples-com-3CD, results='asis'}
xx %>%
  filter(area %in% c("3CD")) %>%
  filter(!is.na(length), year > 1955) %>%
  filter(year < 2018) %>%
  group_by(area, year) %>%
  summarize(
    nlength_m = sum(sex == 1),
    nlength_f = sum(sex == 2),
    nlength_u = sum(sex == 0)

  ) %>%
  rename(
    Area = area, Year = year, `N male` = nlength_m,
    `N female` = nlength_f, `N unsexed` = nlength_u ) %>%
  knitr::kable(caption = "Nombre (N) de mesures de longueur prises dans la pêche commerciale au chalut dans la zone 3CD.", booktabs = TRUE, format = "pandoc", linesep = "", longtable=TRUE)%>%
  kableExtra::kable_styling(latex_options = c("hold_position", "repeat_header"), font_size = 10)
```

\clearpage

```{r length-plot-frequencies-com, fig.cap="Fréquences selon la longueur de la morue du Pacifique prises dans la pêche commerciale au chalut. Par souci de clarté, seules les longueurs depuis 1996 sont indiquées.", fig.asp=1.4}

xx %>%
 filter(!is.na(area)) %>%
 filter(year >= 1996) %>%
  filter(year < 2018) %>%
 filter(species_category_code %in% 1) %>%
 do(gfplot:::bin_lengths(., value = length, bin_size = 2)) %>%
 rename(length_bin = length) %>%
 group_by(year, length_bin, area) %>%
 summarise(n = n()) %>%
 group_by(year, area) %>%
 mutate(proportion = n / sum(n), total = sum(n)) %>%
 ungroup() %>%
 mutate(sex = "M", survey_abbrev = area) %>% # sex = "M" is a trick to plot them all
 plot_lengths() + xlab("Length (cm)") +
 guides(colour = FALSE, fill = FALSE)


```

\clearpage

## ÉCHANTILLONS D’ÂGE

L’âge de la morue du Pacifique est difficile à déterminer en raison de l’incohérence des marques annuelles, surtout au cours des premières années de vie [@beamish1981; @johnston2012; @kastelle2017]. Une récente étude de validation fondée sur la microchimie des otolithes de la morue du Pacifique de l’Alaska a révélé que la détermination visuelle de l’âge des otolithes entraînait une forte probabilité de sur-vieillir les poissons âgés de 3 à 4 ans. En effet, les lecteurs ont du mal à distinguer les anneaux de croissance (zones translucides) des annuli [@kastelle2017]. En raison des grandes difficultés que pose l’interprétation des modèles de croissance des otolithes de la morue du Pacifique de la Colombie-Britannique, nous avons déterminé ici l’âge des poissons en utilisant des coupes des rayons des nageoires dorsales, bien que cette méthode ne soit pas validée [@beamish1981]. La détermination de l’âge à partir des coupes des rayons de nageoires exige beaucoup de ressources, car les nageoires doivent être séchées, sectionnées et montées dans de la résine avant la lecture. C’est pourquoi on n’a pas régulièrement déterminé l’âge des morues du Pacifique pour les populations de la Colombie-Britannique.

En 2012, une demande dans ce sens a été présentée, à partir des rayons de nageoires dorsales recueillis lors des récents relevés synoptiques effectués dans le détroit d’Hécate et le bassin de la Reine-Charlotte et sur la côte ouest de l’île de Vancouver. Au total, on a déterminé l’âge de `r total_aged` rayons de nageoires, couvrant les années 2007, 2009, 2011 pour le SYN HS, 2011 pour le SYN QCS et 2006, 2008 et 2010 pour le SYN WCVI. Un récapitulatif du nombre de poissons dont l’âge a été déterminé, par année, relevé et sexe, est fourni dans le tableau \@ref(tab:age-biosamples). Les proportions à chaque âge sont indiquées sur la figure \@ref(fig:age-plotages). En raison des difficultés d’interprétation des annuli pour la morue du Pacifique, un deuxième lecteur a procédé à la lecture d’un sous-ensemble des rayons de nageoires. Il y a ainsi eu 162 lectures secondaires pour la zone 5CD et 57 pour la zone 3CD. Les résultats ont montré que les lectures de précision différaient parfois de la lecture primaire d’une année ou plus, particulièrement pour les poissons plus âgés (figure \@ref(fig:age-precision)).

Étant donné les petites plages d’années pour lesquelles on dispose de l’âge des poissons, ces données ne sont pas suffisantes pour appuyer un modèle d’évaluation des stocks structuré selon l’âge. Toutefois, elles peuvent servir à estimer les paramètres de croissance et de maturité et peuvent être utiles pour visualiser les compositions probables selon l’âge dans les données sur les prises commerciales.

\clearpage

```{r age-biosamples, results='asis'}
x %>%
  filter(survey_abbrev %in% c("SYN HS", "SYN QCS", "SYN WCVI")) %>%
  filter(!is.na(age)) %>%
  group_by(survey_abbrev, year) %>%
  summarize(
    nage_m = sum(sex == 1),
    nage_f = sum(sex == 2) #,
    #proportion_male = sprintf("%.2f", round(nage_m / (nage_f + nage_m), 2)),
    #proportion_female = sprintf("%.2f", round(nage_f / (nage_f + nage_m), 2))
  ) %>%
  rename(
    Survey = survey_abbrev, Year = year, `N male` = nage_m,
    `N female` = nage_f #,
    #`P male` = proportion_male,
    #`P female` = proportion_female
  ) %>%
  knitr::kable(caption = "Nombres (N) d’otolithes dont l’âge a été déterminé pour les relevés synoptiques effectués dans le détroit d’Hécate (SYN HS), le bassin de la Reine-Charlotte (SYN QCS) et sur la côte ouest de l’île de Vancouver (SYN WCVI).", booktabs = TRUE, format = "pandoc", linesep = "")
```

```{r age-plotages, fig.cap="Proportions selon l’âge des poissons dont l’âge a été déterminé pour les relevés synoptiques effectués dans le détroit d’Hécate (SYN HS), le bassin de la Reine-Charlotte (SYN QCS) et sur la côte ouest de l’île de Vancouver (SYN WCVI). Cercles gris = mâles. Cercles rouges = femelles."}
tidy_ages_raw(x,
  survey = c("SYN HS", "SYN QCS", "SYN WCVI"),
  ageing_method_codes = 6
) %>%
  plot_ages(
    count_label_size = 3, diagonal_lines = seq(-2100, -1850, 2),
    max_size = 12
  ) +
  scale_x_continuous(breaks = 2006:2011) +
  scale_y_continuous(breaks = seq(1, 10)) +
  ggtitle("") +
  ylim(0, NA)
```


```{r age-precision, fig.cap="Précision de la détermination de l’âge pour la morue du Pacifique. Chaque point et hachure représente un poisson individuel dont l’âge a été déterminé deux fois. L’axe des x représente l’âge et l’intervalle de confiance consignés par le lecteur principal. L’axe des y représente l’âge et l’intervalle de confiance consignés par le deuxième lecteur. La ligne diagonale tiretée représente un parfait accord un à un entre les deux lectures de l’âge. On a ajouté une petite quantité de fluctuation aléatoire aux deux axes pour en améliorer la précision de lecture.", fig.asp=1, out.width="3in", fig.width=4}
tidy_age_precision(d$age_precision, ageing_method_codes = 6) %>%
  plot_age_precision(n = 1e6) +
  scale_x_continuous(breaks = seq(0, 10, 1)) +
  scale_y_continuous(breaks = seq(0, 10, 1)) +
  ggtitle("")
```

\clearpage

## GROWTH PARAMETERS

## PARAMÈTRES DE CROISSANCE

On a estimé les paramètres de croissance en ajustant la fonction de croissance de von Bertalanffy aux données sur l’âge et la longueur :

\begin{equation}
L_{s} = L_{\infty,s}\left( 1 - e^{- k_{s}\left( a_{s} - {a_{0}}_{s} \right)} \right)
 (\#eq:vB)
\end{equation}

où $L_{\infty,s}$, $k_{s}$ et ${a_{0}}_{s}$ sont les paramètres de l’équation propres au sexe, et $L_{s}$ et $a_{s}$ sont les observations jumelées de la longueur ($L$) et de l’âge ($a$) tirées des relevés synoptiques (tableaux \@ref(tab:length-biosamples-surv) et \@ref(tab:age-biosamples)). Nous avons permis une erreur d’observation log-normale.

Le modèle a été ajusté aux données des sexes combinés pour : a) tous les échantillons jumelés âge-longueur; b) les échantillons âge-longueur du détroit d’Hécate et du bassin de la Reine-Charlotte; c) les échantillons âge-longueur de la côte ouest de l’île de Vancouver (figures @ref(fig:vb-figs) et \@ref(fig:age-vb-pars); tableau \@ref(tab:age-coeff-table)). Les échantillons du détroit d’Hécate et du bassin de la Reine-Charlotte ont été combinés parce qu’il n’y a eu qu’une année d’observations de l’âge (2011) pour le bassin de la Reine-Charlotte (tableau \@ref(tab:age-biosamples)). Nous avons échantillonné les distributions conjuguées a posteriori de chaque modèle avec Stan [@carpenter2017; @rstan2018] en utilisant quatre chaînes et 2 000 itérations par chaîne, en rejetant la première moitié de chacune comme échauffement. Nous avons placé les valeurs a priori uniformes limitées à zéro sur $k$, $L_{\infty}$ et $\sigma$ (écart-type de l’observation log-normale), et une valeur a priori uniforme sur $a_0$.

\clearpage

```{r age-fit-vb, results='hide'}
surveys_list <- list(
  `SYN HS, SYN QCS, SYN WCVI` = c("SYN HS", "SYN QCS","SYN WCVI"),
  `SYN HS, SYN QCS` = c("SYN HS", "SYN QCS"),
  `SYN WCVI` = "SYN WCVI"
)

sexes <- c("all")
vb_fits <-
  map(surveys_list, function(.survey) {
    map(sexes, function(.sex) {
      .dat <- filter(x, is.element(survey_abbrev, .survey))
      fit_vb(.dat, .sex, method = "mcmc", chains = 4L, iter = 2000L,
        uniform_priors = TRUE, seed = 1,
        cores = parallel::detectCores(),
        control = list(adapt_delta = 0.99, max_treedepth = 20L))
    })
  })
```


\clearpage

```{r age-coeff-table, results='asis'}
get_par_df <- function(.d, element = 1) {
  map_df(vb_fits, function(.x) {
    broom::tidyMCMC(.x[[element]]$model, conf.int = TRUE, conf.level = 0.95) %>%
    select(-std.error) %>%
    mutate(Surveys = paste(unique(.x[[element]]$data$survey_abbrev), collapse = ", ")) %>%
    mutate(Sex = paste(unique(.x[[element]]$data$survey_abbrev), collapse = ", ")) %>%
    mutate(Sex = sexes[element]) %>%
    filter(term != "sigma")
})}
get_par_df(vb_fits, 1) %>%
  # bind_rows(get_par_df(vb_fits, 2)) %>%
  # bind_rows(get_par_df(vb_fits, 3)) %>%
  mutate(term = gsub("^k$", "$k$", term)) %>%
  mutate(term = gsub("^linf$", "$L_{\\\\infty}$", term)) %>%
  mutate(term = gsub("^t0$", "$a_0$", term)) %>%
  mutate(Sex = gsub("^male$", "Male", Sex)) %>%
  mutate(Sex = gsub("^female$", "Female", Sex)) %>%
  mutate(Sex = gsub("^all$", "Male and Female", Sex)) %>%
  mutate(Surveys = factor(Surveys, levels = rev(names(surveys_list))))     %>%
  rename(Term = term, Estimate = estimate, Conf.low = conf.low, Conf.high = conf.high) %>%
  dplyr::select(Surveys,Term, Estimate, Conf.low, Conf.high) %>%
  mutate(Estimate = f(Estimate, 2),
    Conf.low = f(Conf.low, 2), Conf.high = f(Conf.high, 2)) %>%
  knitr::kable(
    caption = "Coefficients de croissance de von Bertalanffy pour la morue du Pacifique dans les relevés synoptiques effectués dans le détroit d’Hécate (SYN HS), le bassin de la Reine-Charlotte (SYN QCS) et sur la côte ouest de l’île de Vancouver (SYN WCVI). Le modèle de la zone 5ABCD a utilisé les paramètres indiqués pour le SYN HS et le SYN QCS. Le modèle de la zone 3CD a utilisé les paramètres indiqués pour le SYN WCVI.",
    booktabs = TRUE, linesep = "", escape=FALSE, format = "pandoc",
    align = c("l", "l", "l", "r", "r", "r")) %>%
  row_spec(seq(13, 18), bold = TRUE)
```

```{r vb-figs, fig.cap = "Ajustements du modèle de l’âge selon la longueur. La courbe de croissance de l’âge selon la longueur est un modèle de von Bertalanffy. Le texte dans les graphiques montre les estimations des paramètres et les points représentent les données pour les poissons individuels.", fig.asp=0.3, fig.width=9, out.width="6.5in"}
vb_figs <- map(vb_fits, ~ plot_vb(
  object_all = .x[[1]],
  col = c(All = "grey30"), lab_x = 0.38) +
    ggtitle(paste(unique(.x[[1]]$data$survey_abbrev), collapse = ", ")) +
    guides(colour = FALSE)
)
g_vb <- cowplot::plot_grid(plotlist = vb_figs, nrow = 1)
print(g_vb)
```

```{r vb-figs-svg}
g_vb2 <- cowplot::plot_grid(plotlist = list(vb_figs[[2]], vb_figs[[3]]), nrow = 1)
cowplot::save_plot(here::here('presentations/figures/growth-vb.svg'), plot = g_vb2, base_width = 4, base_height = 3, ncol = 2)

```

```{r age-vb-pars, fig.asp=0.4, fig.cap = "Estimations de coefficients du modèle de von Bertalanffy."}
get_par_df <- function(.d, element = 1) {
  map_df(vb_fits, function(.x) {
    broom::tidyMCMC(.x[[element]]$model, conf.int = TRUE, conf.level = 0.95) %>%
    select(-std.error) %>%
    mutate(surveys = paste(unique(.x[[element]]$data$survey_abbrev), collapse = ", ")) %>%
    mutate(Sex = paste(unique(.x[[element]]$data$survey_abbrev), collapse = ", ")) %>%
    mutate(Sex = sexes[element]) %>%
    filter(term != "sigma")
})}
get_par_df(vb_fits, 1) %>%
  # bind_rows(get_par_df(vb_fits, 2)) %>%
  # bind_rows(get_par_df(vb_fits, 3)) %>%
  mutate(surveys = factor(surveys, levels = rev(names(surveys_list))))  %>%
  mutate(term = gsub("^t0$", "a_0", term)) %>%
  ggplot(aes(surveys, estimate, colour = Sex, ymin = conf.low, ymax = conf.high)) +
  geom_pointrange(position = position_dodge(width = 0.2)) +
  facet_wrap(~term, scales = "free_x") +
  coord_flip() +
  ylab("Parameter value") +
  xlab("") +
  theme_pbs() +
  scale_color_manual(values = c("all" = "grey30")) +
  guides(colour = FALSE)

vbp <- get_par_df(vb_fits, 1)
  # bind_rows(get_par_df(vb_fits, 2))
# vbp_wci_m <- filter(vbp, term == "k", surveys == "SYN WCVI", Sex == "male") %>% pull(estimate) %>% round(3)
# vbp_wci_f <- filter(vbp, term == "k", surveys == "SYN WCVI", Sex == "female") %>% pull(estimate) %>% round(3)
# vbp_hsqcs_m <- filter(vbp, term == "k", surveys == "SYN HS, SYN QCS", Sex == "male") %>% pull(estimate) %>% round(3)
# vbp_hsqcs_f <- filter(vbp, term == "k", surveys == "SYN HS, SYN QCS", Sex == "female") %>% pull(estimate) %>% round(3)
# vbp_all_m <- filter(vbp, term == "k", surveys == "SYN HS, SYN QCS, SYN WCVI", Sex == "male") %>% pull(estimate) %>% round(3)
# vbp_all_f <- filter(vbp, term == "k", surveys == "SYN HS, SYN QCS, SYN WCVI", Sex == "female") %>% pull(estimate) %>% round(3)

vbp_wci <- filter(vbp, term == "k", surveys == "SYN WCVI") %>% pull(estimate) %>% round(2)
vbp_hsqcs <- filter(vbp, term == "k", surveys == "SYN HS, SYN QCS") %>% pull(estimate) %>% round(2)
vbp_all <- filter(vbp, term == "k", surveys == "SYN HS, SYN QCS, SYN WCVI") %>% pull(estimate) %>% round(2)
```

Les estimations du taux de croissance de von Bertalanffy $k$ étaient plus élevées dans le relevé sur la COIV ($k$ = `r vbp_wci` y^-1^) que celles de $k$ dans les relevés combinés du détroit d’Hécate et du bassin de la Reine-Charlotte ($k$ = `r vbp_hsqcs` y^-1^) et de tous les relevés combinés ($k$ = `r vbp_all` y^-1^) (tableau \@ref(tab:age-coeff-table)). Les évaluations des stocks de 2013 pour le détroit d’Hécate et le bassin de la Reine-Charlotte [@forrest2013] ont utilisé les mêmes paramètres de croissance que ceux employés dans l’évaluation de 2004 pour le détroit d’Hécate ($L_{\infty}$ = 89,48 cm; $k$ = 0,307 y^-1^ et $a_0$ = -0,116 y [@sinclair2005]). Ces valeurs avaient été indiquées par @westrheim1996 pour le stock de la COIV, d’après les analyses des données sur la fréquence des longueurs [@foucher1982]. @westrheim1996 avait en fait présenté un taux de croissance plus faible pour le stock du détroit d’Hécate, $k$ = 0,203 y^-1^.

Les résultats actuels pour le détroit d’Hécate (tableau \@ref(tab:age-coeff-table)) sont conformes aux paramètres indiqués par @westrheim1996. On peut en déduire que le taux de croissance utilisé dans les modèles de type différence-délai de @forrest2013 et @sinclair2005 était peut-être trop élevé pour le stock du détroit d’Hécate. Les modèles du scénario de référence actuels utilisent donc les paramètres de croissance indiqués dans le tableau \@ref(tab:age-coeff-table), c.-à-d. "SYN HS, SYN QCS" pour la zone 5ABCD et "SYN WCVI" pour la zone 3CD.

\clearpage

Les paramètres de longueur-poids (équation \@ref(eq:weight-length)) ont été estimés à l’aide des données jumelées de longueur et de poids provenant des relevés synoptiques.

\begin{equation}
W_{s} = \alpha_{s}{L_{s}}^{\beta_{s}}
 (\#eq:weight-length)
\end{equation}

où $\alpha_s$ et $\beta_s$ sont les paramètres de l’équation propres au sexe et où $L_s$ et $W_s$ sont les observations jumelées de la longueur ($L$) et du poids ($W$) des relevés synoptiques (tableaux \@ref(tab:length-biosamples-surv) et \@ref(tab:weight-biosamples)). En ce qui concerne les paramètres de croissance, l’équation \@ref(eq:weight-length) a été évaluée à l’aide des données de tous les relevés combinés; des relevés HS-QCS combinés; et du relevé WCVI (figures \@ref(fig:age-lw-figs) et \@ref(fig:age-lw-pars), tableau \@ref(tab:lw-coeff-table)). Les modèles correspondaient à des régressions linéaires solides : $\ln(W_s) = \ln(a) + b \cdot \ln(L_s)$ avec un estimateur M [@venables2002]. Nous avons choisi des modèles linéaires solides plutôt que des modèles linéaires avec une erreur à distribution normale pour réduire l’influence d’un petit nombre de spécimens aberrants.

```{r age-fit-lw, results='hide'}
lw_fits <-
  map(surveys_list, function(.survey) {
    map(sexes, function(.sex) {
      .dat <- filter(x, is.element(survey_abbrev, .survey))
      fit_length_weight(.dat, .sex, method = "rlm")
    })
  })
```

```{r lw-coeff-table}
get_par_df <- function(.d, element = 1) {
  map_df(lw_fits, function(.x) {
    broom::tidy(.x[[element]]$model) %>%
    mutate(Surveys = paste(unique(.x[[element]]$data$survey_abbrev), collapse = ", ")) %>%
    mutate(Sex = paste(unique(.x[[element]]$data$survey_abbrev), collapse = ", ")) %>%
    mutate(Sex = sexes[element]) %>%
    filter(term != "statistic")
})}
get_par_df(lw_fits, 1) %>%
  # bind_rows(get_par_df(lw_fits, 2)) %>%
  # bind_rows(get_par_df(lw_fits, 3)) %>%
  mutate(Conf.low = estimate - 1.96 * std.error, Conf.high = estimate + 1.96 * std.error) %>%
  mutate(Surveys = factor(Surveys, levels = rev(names(surveys_list)))) %>%
  mutate(term = gsub("\\(Intercept\\)", "$ln(\\\\alpha_s)$", term)) %>%
  mutate(term = gsub("log\\(length\\)", "$\\\\beta_s$", term)) %>%
  mutate(Sex = gsub("^male$", "Male", Sex)) %>%
  mutate(Sex = gsub("^female$", "Female", Sex)) %>%
  mutate(Sex = gsub("^all$", "Male and Female", Sex)) %>%
  rename(Term = term, Estimate = estimate) %>%
  dplyr::select(Surveys,Sex,Term, Estimate, Conf.low, Conf.high) %>%
  knitr::kable(caption = "Coefficients longueur-poids pour la morue du Pacifique dans les relevés synoptiques effectués dans le détroit d’Hécate (SYN HS), le bassin de la Reine-Charlotte (SYN QCS) et sur la côte ouest de l’île de Vancouver (SYN WCVI).", booktabs = TRUE, format = "pandoc", linesep = "", digits=2, escape=FALSE)
```

```{r age-lw-figs, fig.cap = "Ajustements du modèle longueur-poids. Le texte dans les graphiques montre les estimations des paramètres et les points représentent les données pour les poissons individuels.", fig.asp=0.28, fig.width=9, out.width="6.5in"}
lw_figs <- map(lw_fits, ~ plot_length_weight(
  object_all = .x[[1]],
      col = c(All = "grey30"), lab_x_gap = 0.45) +
    ggtitle(paste(unique(.x[[1]]$data$survey_abbrev), collapse = ", ")) +
    guides(colour = FALSE)
  )
cowplot::plot_grid(plotlist = lw_figs, nrow = 1)
```

```{r age-lw-pars, fig.asp=0.4, fig.cap = "Coefficients des ajustements du modèle longueur-poids."}
get_par_df <- function(.d, element = 1) {
  map_df(lw_fits, function(.x) {
    broom::tidy(.x[[element]]$model) %>%
    mutate(surveys = paste(unique(.x[[element]]$data$survey_abbrev), collapse = ", ")) %>%
    mutate(Sex = paste(unique(.x[[element]]$data$survey_abbrev), collapse = ", ")) %>%
    mutate(Sex = sexes[element]) %>%
    filter(term != "statistic")
})}
get_par_df(lw_fits, 1) %>%
  # bind_rows(get_par_df(lw_fits, 2)) %>%
  # bind_rows(get_par_df(lw_fits, 3)) %>%
  mutate(conf.low = estimate - 1.96 * std.error, conf.high = estimate + 1.96 * std.error) %>%
  mutate(surveys = factor(surveys, levels = rev(names(surveys_list)))) %>%
  mutate(term = gsub("\\(Intercept\\)", "ln(a_s)", term)) %>%
  mutate(term = gsub("log\\(length\\)", "b_s", term)) %>%
  ggplot(aes(surveys, estimate, colour = Sex, ymin = conf.low, ymax = conf.high)) +
  geom_pointrange(position = position_dodge(width = 0.2)) +
  facet_wrap(~term, scales = "free_x") +
  coord_flip() +
  ylab("Parameter value") +
  xlab("") +
  theme_pbs() +
  scale_color_manual(values = c("all" = "grey30")) +
  guides(colour = FALSE)
```

\clearpage

## PARAMÈTRES DE LA MATURITÉ

La maturité de la morue du Pacifique est évaluée par une inspection visuelle des gonades, qui permet d’attribuer un code à la maturité selon le stade de maturité pour les gadidés. Les poissons sont évalués comme relevant de l’un des six états suivants : 1.immature; 2.en cours de maturation; 3.mature (repos); 4.mature; 5.mature (guai); et 6.mature (plein). Pour pouvoir l’ajuster à une courbe logistique, on a attribué à la maturité un code binaire, où les poissons dont les gonades présentent un code de maturité de 3 ou plus étaient définis comme matures (maturité attribuée 1), et les poissons dont les gonades présentent un code de 1 ou 2 étaient définis comme immatures (maturité attribuée 0).

Nous avons ajusté les ogives de la maturité en tant que régressions logistiques de la maturité (mature par rapport à immature) selon la longueur ou l’âge :

\begin{align}
y_i &\sim \mathrm{Binomial}(\pi_i)\\
\mathrm{logit} \left( \pi_i \right) &= \beta_0 + \beta_1 x_i + \beta_2 F_i +  \beta_3 x_i F_i
 (\#eq:maturity)
\end{align}

où $y_i$ représente un 1 si le poisson $i$ est considéré comme étant mature et un 0 si le poisson $i$ est considéré comme étant immature. Les paramètres $\beta$ représentent les coefficients estimés, $x_i$ l’âge du poisson $i$ et $F_i$ un prédicteur binaire qui a la valeur 1 si le poisson est une femelle et 0 si le poisson est un mâle. La variable $\pi_i$ représente la probabilité prévue que le poisson $i$ soit mature. Nous pouvons ensuite calculer l’âge à 50 % de maturité comme suit : $-(\log(1 / 0.5 - 1) + \beta_0) / \beta_1$ ou $-(\log(1) + \beta_0) / \beta_1$ pour les mâles et $-(\log(1) + \beta_0 + \beta_2) / (\beta_1 + \beta_3)$ pour les femelles.

Les paramètres estimés sont fournis dans les tableaux \@ref(tab:mat-fifty-tab) et \@ref(tab:age-mat-coefs-table), ainsi que sur la figure \@ref(fig:age-mat-coefs). Les ogives de la maturité estimée sont présentées sur la figure \@ref(fig:age-mat-figs).

D’après les résultats, l’âge de 3 ans pourrait être une hypothèse plus appropriée pour la maturité en lame de couteau que l’âge de 2 ans.

```{r age-fit-maturity}
surveys_list <- list(
  `SYN HS, SYN QCS, SYN WCVI` = c("SYN HS", "SYN QCS","SYN WCVI"),
  `SYN HS, SYN QCS` = c("SYN HS", "SYN QCS"),
  `SYN WCVI` = "SYN WCVI"
)
mat_fits <- map(surveys_list, function(.survey) {
  .dat <- filter(x, is.element(survey_abbrev, .survey))
  fit_mat_ogive(.dat, type = "age")
})
```

\clearpage

```{r age-mat-coefs-table, results='asis'}
mat_coefs <- plyr::ldply(mat_fits, function(.x) {
  broom::tidy(.x$model, conf.int = TRUE)
})

est <- group_by(mat_coefs, .id) %>%
  summarise(
    intercept_male = estimate[term == "(Intercept)"],
    intercept_female = estimate[term == "(Intercept)"] + estimate[term == "female"],
    slope_male = estimate[term == "age_or_length"],
    slope_female = estimate[term == "age_or_length"] +
    estimate[term == "age_or_length:female"]
  ) %>% reshape2::melt(variable.name = "term", value.name = "estimate")

combine_se <- function(se1, se2) {
  sqrt(se2^2 - se1^2)
}

se <- group_by(mat_coefs, .id) %>%
  summarise(
    intercept_male = std.error[term == "(Intercept)"],
    intercept_female = combine_se(std.error[term == "(Intercept)"],
      std.error[term == "female"]),
    slope_male = std.error[term == "age_or_length"],
    slope_female = combine_se(std.error[term == "age_or_length"],
      std.error[term == "age_or_length:female"])
  ) %>% reshape2::melt(variable.name = "term", value.name = "std.error")
inner_join(est, se) %>%
  mutate(.id = factor(.id, levels = names(surveys_list))) %>%
  mutate(term = gsub("^intercept_male$", "Intercept male: $\\\\beta_0$", term)) %>%
  mutate(term = gsub("^intercept_female$", "Intercept female: $\\\\beta_0 + \\\\beta_2$", term)) %>%
  mutate(term = gsub("^slope_female$", "Slope female: $\\\\beta_1 + \\\\beta_3$", term)) %>%
  mutate(term = gsub("^slope_male$", "Slope male: $\\\\beta_1$", term)) %>%
  mutate(Conf.low = estimate - 1.96 * std.error, Conf.high = estimate + 1.96 * std.error) %>%
  rename(Survey = .id, Term = term, Estimate = estimate) %>%
  dplyr::select(Survey,Term, Estimate, Conf.low, Conf.high) %>%
   knitr::kable(caption = "Coefficients des ogives de la maturité par régression logistique.",
     booktabs = TRUE, linesep = "", digits=2, format = "pandoc", escape=FALSE)
```

```{r mat-fifty-tab, results = 'asis'}
plyr::ldply(mat_fits, function(.x)
  data.frame(Female = .x$mat_perc$f.p0.5, Male = .x$mat_perc$m.p0.5)) %>%
  melt() %>%
  mutate(.id = factor(.id, levels = names(surveys_list))) %>%
  rename(Survey = .id, Sex = variable, `Estimated age-at-50% maturity` = value) %>%
  arrange(Survey, Sex) %>%
  knitr::kable(
    caption = "Estimations de l’âge à 50\\% de maturité d’après les ogives de la maturité par régression logistique.", booktabs = TRUE, format = "pandoc", linesep = "", digits=1)
```

\clearpage

```{r age-mat-figs, fig.cap = "Ogives de l’âge à maturité. Les ogives de la maturité sont ajustées en tant que régressions logistiques aux spécimens de poissons individuels, qui sont classés comme étant matures ou non matures. Les lignes noires pleines représentent les ajustements aux poissons femelles et les lignes grises tiretées représentent les ajustements aux poissons mâles. Les lignes verticales indiquent l’âge ou la longueur estimés à 50\\% de maturité. Le texte dans les graphiques indique l’âge et la longueur estimés à 5, 50 et 95\\% de maturité pour les femelles (F) et les mâles (M). Les traits courts le long du haut et du bas de chaque graphique représentent jusqu’à 1 500 poissons choisis au hasard, avec une petite fluctuation aléatoire pour aider à différencier les poissons individuels.", fig.asp=1.7, fig.width=4.5, out.width="3.4in"}
mat_figs <- map(mat_fits, ~ plot_mat_ogive(.x) +
    coord_cartesian(xlim = c(0, 8.2), ylim = c(0, 1), expand = FALSE))
for (i in seq_along(mat_figs))
  mat_figs[[i]] <- mat_figs[[i]] + ggtitle(names(surveys_list)[i])
cowplot::plot_grid(plotlist = mat_figs, ncol = 1)
```

```{r age-mat-coefs, fig.pos = "H", fig.cap = "Coefficients réorganisés à partir des ogives de la maturité par régression logistique (p. ex. intercept female = $\\beta_0 + \\beta_2$). Les paramètres sont dans l’espace logit ou des probabilités logarithmiques. L’interception fait référence aux probabilités logarithmiques de la maturité pour un poisson théorique de 0 an.", fig.width=6, out.width="4.5in"}
#based on outputs from age-mat-coefs-table
inner_join(est, se) %>%
  mutate(conf.low = estimate - 1.96 * std.error) %>%
  mutate(conf.high = estimate + 1.96 * std.error) %>%
  mutate(.id = factor(.id, levels = names(surveys_list))) %>%
  ggplot(aes(ymin = conf.low, ymax = conf.high, y = estimate,
    x = term, colour = .id)) +
  geom_pointrange(position = position_dodge(width = 0.4)) +
  coord_flip() +
  theme_pbs() +
  xlab("") + ylab("Coefficient") +
  labs(colour = "Survey group") +
  scale_color_brewer(palette = "Dark2")
```

\clearpage

## MOYENNE DU POIDS MOYEN ANNUEL DANS LES PRISES COMMERCIALES

Le calcul du poids moyen annuel a été effectué selon les étapes suivantes. Les mêmes étapes ont été appliquées dans les zones 3CD et 5ABCD. La même relation longueur-poids a été utilisée pour tous les trimestres, mais elle différait selon la zone. Pour la zone 3CD, les valeurs des paramètres de poids-longueur utilisées sont les suivantes : `r paste0("$\\alpha = ", .ALPHA3, "$")` et `r paste0("$\\beta = ", .BETA3, "$")`; pour la zone 5ABCD : `r paste0("$\\alpha = ", .ALPHA, "$")` et `r paste0("$\\beta = ", .BETA, "$")`.

*Étape 1.* Convertir la longueur individuelle ($l_i$) dans chaque ID d’échantillon ($j$) en poids ($w_i$) :

\begin{equation}
{W_i} = a^q{L_i}^{b^q}
\end{equation}

où $a^q$ et $b^q$ sont des paramètres de longueur-poids constants.

*Étape 2.* À partir de l’ensemble de données sélectionné, calculer le poids moyen ($W_j$) pour chaque ID d’échantillon ($j$) :

\begin{equation}
{W_j} = \frac{{\sum\limits_{i=1}^{{N_j}} {{w_{i,j}}} }}{{{N_j}}}
\end{equation}

où $N_j$ est le nombre de poids en $w_{ij}$ dans l’ID d’échantillon ($j$).

*Étape 3.* Calculer ensuite le poids moyen ($W_s$) pour chaque trimestre séquentiel, pondéré par le poids de l’échantillon de la morue du Pacifique ($S_j$) dans chaque ID d’échantillon ($j$). Si le poids de l’échantillon a été consigné dans les données, il est utilisé. Sinon, on utilise la somme des poids calculés à partir de l’échantillon :

\begin{equation}
{W_s} = \frac{{\sum\limits_{i=1}^{{K_s}} {{W_{j,s}S_{j,s}}}}}{{\sum\limits_{j=1}^{{K_s}} {{S_{j,s}}}}}
\end{equation}

où $K_j$ est le nombre d’ID d’échantillon ($j$) dans le trimestre séquentiel ($s$), où le trimestre séquentiel est un identificateur unique pour chaque trimestre dans la série chronologique.

*Étape 4.* Calculer le poids moyen ($W_f$) pour une année de pêche en faisant la moyenne du poids moyen trimestriel pondéré par les prises commerciales de morue du Pacifique ($C_s$) au cours du trimestre séquentiel ($s$) :

\begin{equation}
{W_f} = \frac{{\sum\limits_{s=1}^{{4}} {{W_sC_s}}}}{{\sum\limits_{s=1}^{{4}} {{C_s}}}}
\end{equation}

\clearpage
