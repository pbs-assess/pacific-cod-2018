---
title: |
  2018 Pacific cod stock assessment for Hecate Strait, Queen Charlotte Sound (5ABCD) and West Coast Vancouver Island (3CD)
subtitle:  CPUE Standardization
author: |
  Robyn E. Forrest, Sean Anderson, Chris Grandin, Paul Starr
date: "`r Sys.Date()`"
output:
  xaringan::moon_reader:
    lib_dir: libs
    mathjax: "https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_HTMLorMML"
    nature:
      titleSlideClass: [center, middle]
      ratio: "16:9"
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
css: pcod.css
---

```{r setup, include=FALSE, cache=FALSE, warnings=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE,
                      cache = TRUE,
                      autodep = TRUE,
                      cache.comments = FALSE,
                      fig.align = "center",
                      fig.width = 9,
                      dev = 'svg',
                      fig.asp = 0.618)
options(htmltools.dir.version = FALSE)
library(knitr)
library(ggplot2)
library(dplyr)
library(gfplot)
```


class: inverse, middle, center

# The goal of commercial CPUE index standardization

---

class: middle

<h2 style="color:black">Create an index of Pacific Cod abundance from commercial trawl CPUE that spans from the 1950s to present....</h2>

<h2 style="color:white">while accounting for the effect of variables that we know have changed through time where possible (e.g. where and when fishing occurs).</h2>

---

class: middle

<h2 style="color:grey">Create an index of Pacific Cod abundance from commercial trawl CPUE that spans from the 1950s to present....</h2>

<h2 style="color:black">while accounting, where possible, for the effects of variables that we know have changed through time (e.g. where and when fishing occurs).</h2>


---

```{r cpue-params}
params <- list()
params$species_proper <- "Pacific Cod"
params$april1_year <- TRUE
params$area <- c("5[ABCD]+", "3[CD]+")
params$area_name <- c("5ABCD", "3CD")
params$skip_single_variable_models <- FALSE
```

```{r cpue-run-historic, message=FALSE, warning=FALSE, results='hide', include=FALSE}
params$era <- "historic"
source(here::here("R/cpue.R"))
dfleet_hist <- dfleet
gg_cpue_hist <- gg_cpue
cpue_pred_hist <- predictions
arith_cpue_hist <- arith_cpue
m_historic <- readRDS(here::here("data/generated/cpue-models-pcod-historic.rds"))
```

```{r cpue-run-modern, message=FALSE, warning=FALSE, results='hide', include=FALSE}
params$era <- "modern"
source(here::here("R/cpue.R"))
dfleet_modern <- dfleet
gg_cpue_modern <- gg_cpue
cpue_pred_modern <- predictions
arith_cpue_modern <- arith_cpue
m_modern <- readRDS(here::here("data/generated/cpue-models-pcod-modern.rds"))
```

```{r cpue-functions}
source(here::here('R/cpue-functions.R'))
```

## Depth distribution changes through time

```{r cpue-historical-bubbles-depth}
dfleet_hist %>%
  make_bubble_dat(measure.vars = c("depth")) %>%
  filter(area == "3CD") %>%
  make_facet_bubble_plot(group = "trips") +
  ggtitle("1956-1995 3CD") +
  theme(legend.position = "right")
```

---

## Where fishing occurred changes through time

```{r cpue-locality1, fig.width=9}
g1 <- gfplot:::plot_dfo_localities(unique(dfleet_modern[[1]]$locality_code))
g2 <- gfplot:::plot_dfo_localities(unique(dfleet_modern[[2]]$locality_code))
gridExtra::grid.arrange(g1, g2, ncol = 2)
```

---

## Where fishing occurred changes through time

```{r cpue-historical-bubbles-locality}
dfleet_hist %>%
  make_bubble_dat(measure.vars = c("locality")) %>%
  filter(area == "5ABCD") %>%
  make_facet_bubble_plot(group = "trips") +
  ggtitle("1956-1995 5ABCD") +
  theme(legend.position = "right")
```

---

# Standardization variables 

.pull-left[
### Historical:

- Month
- Locality
- Depth
]

--

.pull-right[
### Modern:

- Month
- Locality
- Depth
- Latitude
- Vessel
]

---

class: middle, center

# Common approach (at PBS):

## Use an unstandardized ratio or use a delta-lognormal GLM.

---

# We extend the delta-lognormal approach in 3 ways:

<br>

--

1. Integrate random effects.

--

2. Use an error distribution that avoids the need for the 2-part 'delta' approach.

--

3. Allow for localities to have different trends through time (space-time interactions).

---

# 1. Extending CPUE standardization: integrate random effects

GLMMs with random effects for factors like vessels, localities, etc.

--

* allow prediction for an average level

--

* create more realistic estimates of uncertainty

--

* make better use of the data

--

* allow for explicit comparison of variance components

---

# 2. Extending CPUE standardization: avoiding a 'delta' approach

Delta-gamma or delta-lognormal index standardization models:

--

* add complexity (2 models)

--

* use 2 GLM links; coefficients cannot be combined

--

* assume independence among the 2 models

--

* may be insufficiently robust to variable sampling intensity

--

* **create an index that is dependent on the reference levels**

---

# 3. Extending CPUE standardization: allowing for space-time interactions

<br>

## If we don't allow for these then we are implicitly assuming that all localities have had the same trend.

---

class: inverse, middle, center

# A Tweedie GLMM standardization model 
# with space-time interactions

---

## The Tweedie distribution

<img src="figures/cpue-tweedie-ex-1.png" height="500" class='center-img'>

---

## A Tweedie GLMM standardization model

A Tweedie observation model:

$$
  y_i \sim \mathrm{Tweedie}(\mu_i, p, \phi), \quad 1 < p < 2,
$$

--

and a log link:

$$
\begin{align}
 \mu_i &= \exp \left(
  \mathbf{X}_i \mathbf{\beta} + \alpha^\mathrm{locality}_{j[i]} + \alpha^\mathrm{locality-year}_{k[i]} + \alpha^\mathrm{vessel}_{l[i]} \right),
\end{align}
$$

with a vector of predictors $X$, fixed effects $\mathbf{\beta}$, and random intercepts $\alpha$.

Fit with TMB.

---

# Data aggregation

### 'Historical' 

- 1956–1990 (dockside interviews): trip-locality-level data

--

- 1991–1995 (logbooks): fishing-event-level rolled up to trip-locality-level data

--

### 'Modern'

- 1996–2017 (on-board observers/video monitoring): fishing-event-level data

---

# Defining the 'modern' fleet

<br>
<br>

- ≥ 100 positive Pacific Cod tows across all years

--

- ≥ 5 positive Pacific Cod trips for ≥ 5 years

---

class: inverse, middle, center

# CPUE standardization results

---

## Randomized quantile residuals

<img src="figures/cpue-quantile-residuals-1.png" height="500" class='center-img'>

---


## Fixed effect coefficients (historical)

```{r cpue-fixed-effects-historical, fig.asp=0.55}
toplot <- c(6, 12)
p <- list()
for (i in seq_along(params$area_name)) {
  p[[i]] <- make_fe_plots(m_historic[[toplot[i]]]) + ggtitle(params$area_name[i])
}
# cowplot::plot_grid(p[[2]], p[[1]], ncol = 1)
print(p[[1]])
```

---

## Fixed effect coefficients (modern)

```{r cpue-fixed-effects-modern, fig.asp=0.55}
toplot <- c(8, 16)
p <- list()
for (i in seq_along(params$area_name)) {
  p[[i]] <- make_fe_plots(m_modern[[toplot[i]]]) + ggtitle(params$area_name[i])
}
# cowplot::plot_grid(p[[2]], p[[1]], ncol = 2)
print(p[[1]])
```

---

## Locality random effects (historical)

<img src="figures/cpue-coef-plot2-1.png" height="500" class='center-img'>

---

## Locality random effects (modern)

<img src="figures/cpue-coef-plot2-modern-1.png" height="500" class='center-img'>

---

## Locality-year random effects (historical)

<img src="figures/cpue-coef-plot3-1.png" height="500" class='center-img'>

---

## Locality-year random effects (modern)

<img src="figures/cpue-coef-plot3-modern-1.png" height="500" class='center-img'>

---

## CPUE standardizations (historical)

<img src="figures/cpue-index-ts-hist-1.png" height="500" class='center-img'>

---

## CPUE standardizations (modern)

<img src="figures/cpue-index-ts-modern-1.png" height="500" class='center-img'>

---

## CPUE standardizations — with and without space-time interactions

<img src="figures/cpue-int-test-plot-1.png" height="500" class='center-img'>

---

## Locality-specific CPUE trends (**with** space-time interactions)

<img src="figures/cpue-re-int-ts-1.png" height="500" class='center-img'>

---

## Locality-specific CPUE trends (**without** space-time interactions)

<img src="figures/cpue-re-no-int-ts-1.png" height="500" class='center-img'>

---

## Simulation testing the space-time assumption

<img src="figures/cpue-sim-test-tweedie-glmm-plot-1.png" height="500" class='center-img'>
